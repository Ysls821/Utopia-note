<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Utopia note·乌托邦手记</title>
    <style>
        :root {
            /* === 你的原始配色系统 (保持不变) === */
            --primary: #d946ef;
            --secondary: #8b5cf6;
            --accent: #06b6d4;
            --bg-deep: #0f0720;
            --gradient-holo: linear-gradient(135deg, rgba(217,70,239,0.8), rgba(139,92,246,0.8), rgba(6,182,212,0.8));
            --gradient-glass: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            --gradient-border: linear-gradient(90deg, #d946ef, #8b5cf6, #06b6d4);
            --glass-surface: rgba(20, 10, 35, 0.4);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.7);
            --shadow-glow: 0 0 20px rgba(139, 92, 246, 0.3);
            --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.3);
            --font-main: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', sans-serif;
        }

        /* === 新增主题：纸间黛蓝 (Reader) === */
        [data-theme="reader"] {
            --primary: #546e7a;       /* 黛蓝 */
            --secondary: #78909c;     /* 灰蓝 */
            --accent: #b0bec5;        /* 浅灰 */
            --bg-deep: #fdfbf7;       /* 纸张米白 */
            
            /* 纸张纹理背景 */
            --gradient-holo: linear-gradient(135deg, #546e7a, #78909c);
            --gradient-glass: rgba(255, 255, 255, 0.8);
            --gradient-border: #cfd8dc;
            
            --glass-surface: rgba(255, 255, 255, 0.6); /* 磨砂纸感 */
            --glass-border: rgba(0, 0, 0, 0.05);
            --text-main: #263238;     /* 深墨色 */
            --text-muted: #607d8b;
            --shadow-glow: none;
            --shadow-card: 0 4px 6px rgba(0,0,0,0.05);
        }

        /* 原有主题变体 (保留) */
        [data-theme="black"] { --primary: #888; --secondary: #666; --accent: #999; --bg-deep: #000000; }
        [data-theme="white"] { --primary: #5b7aef; --secondary: #4461d9; --accent: #2dd4bf; --bg-deep: #f5f7fa; --glass-surface: rgba(255, 255, 255, 0.6); --text-main: #1a1a1a; --text-muted: rgba(0, 0, 0, 0.6); }
        [data-theme="green"] { --primary: #10b981; --secondary: #059669; --accent: #34d399; --bg-deep: #020a06; }
        [data-theme="blue"] { --primary: #3b82f6; --secondary: #2563eb; --accent: #60a5fa; --bg-deep: #020510; }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-deep);
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
            /* 只有默认主题才有星空背景图，Reader主题会覆盖这个 */
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(217, 70, 239, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(6, 182, 212, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(139, 92, 246, 0.1) 0%, transparent 60%);
            background-attachment: fixed;
            transition: background 0.5s, color 0.5s;
        }

        /* 针对 Reader 主题的背景覆盖 */
        [data-theme="reader"] body {
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
        }

        /* SVG 图标通用样式 (新增) */
        .icon {
            width: 20px; height: 20px;
            fill: none; stroke: currentColor; stroke-width: 2;
            stroke-linecap: round; stroke-linejoin: round;
            display: inline-block; vertical-align: middle;
        }

        .aurora-bg {
            position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
            background: conic-gradient(from 0deg at 50% 50%, rgba(139, 92, 246, 0.1), rgba(217, 70, 239, 0.1), rgba(6, 182, 212, 0.1), rgba(139, 92, 246, 0.1));
            filter: blur(80px); animation: rotate 20s linear infinite; z-index: -1; pointer-events: none;
        }
        /* Reader 主题隐藏极光 */
        [data-theme="reader"] .aurora-bg { display: none; }

        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .glass-panel {
            background: var(--glass-surface);
            backdrop-filter: blur(24px) saturate(120%);
            -webkit-backdrop-filter: blur(24px) saturate(120%);
            border: 1px solid var(--glass-border);
            border-top: 1px solid rgba(255,255,255,0.2);
            box-shadow: var(--shadow-card);
        }
        /* Reader 主题去除玻璃高光 */
        [data-theme="reader"] .glass-panel { border-top: 1px solid var(--glass-border); backdrop-filter: none; }

        /* 登录页 */
        .login-page { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; position: relative; z-index: 10; }
        .login-card { width: 100%; max-width: 400px; padding: 40px 30px; border-radius: 24px; text-align: center; position: relative; overflow: hidden; }
        .login-card::after {
            content: ''; position: absolute; inset: 0; border-radius: 24px; padding: 1px;
            background: var(--gradient-border); -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; pointer-events: none;
        }
        .login-title { font-size: 36px; font-weight: 800; margin-bottom: 8px; background: var(--gradient-border); -webkit-background-clip: text; background-clip: text; color: transparent; letter-spacing: -1px; }
        .login-subtitle { color: var(--text-muted); font-size: 14px; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 40px; }
        
        .input-wrapper { position: relative; margin-bottom: 24px; }
        .input-modern {
            width: 100%; padding: 16px 20px;
            background: rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px; color: var(--text-main); font-size: 16px; outline: none; transition: all 0.3s;
        }
        .input-modern:focus { background: rgba(0,0,0,0.2); border-color: var(--secondary); box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.2); }

        .btn-glow {
            width: 100%; padding: 16px; border: none; border-radius: 16px;
            background: var(--gradient-holo); color: white; font-size: 16px; font-weight: 600;
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center; gap: 8px; /* 图标文字间距 */
        }
        .btn-glow:active { transform: scale(0.98); }
        .btn-glow:hover { box-shadow: 0 0 30px rgba(217, 70, 239, 0.4); }

        /* 主界面 */
        .main-hub { display: none; padding: 20px 20px 100px 20px; max-width: 1200px; margin: 0 auto; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        .user-pill { display: flex; align-items: center; gap: 12px; padding: 8px 16px 8px 8px; border-radius: 100px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); }
        .avatar-small { width: 32px; height: 32px; border-radius: 50%; background: var(--gradient-holo); display: flex; align-items: center; justify-content: center; overflow: hidden; color: #fff; }
        .avatar-small img { width: 100%; height: 100%; object-fit: cover; }

        .resource-pill { display: flex; gap: 16px; }
        .res-item { display: flex; align-items: center; gap: 6px; font-size: 14px; font-weight: 600; padding: 6px 12px; border-radius: 12px; }
        .res-icon { color: var(--accent); }

        /* 底部导航 Dock */
        .dock-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 8px; padding: 10px; border-radius: 24px; z-index: 100;
        }
        .dock-item {
            position: relative; width: 50px; height: 50px; border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-muted); cursor: pointer; transition: all 0.3s;
        }
        .dock-item:hover, .dock-item.active { color: var(--text-main); background: rgba(255,255,255,0.15); transform: translateY(-5px); }
        .dock-item.active { color: var(--primary); } /* Reader下用主色 */
        
        /* 视图容器 */
        .view-section { display: none; animation: fadeIn 0.4s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* 副本卡片 */
        .section-header { font-size: 24px; font-weight: 700; margin-bottom: 20px; background: linear-gradient(to right, var(--text-main), var(--text-muted)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: flex; align-items: center; gap: 8px;}
        .section-header svg { color: var(--text-main); -webkit-text-fill-color: initial; } /* 图标不渐变 */

        .grid-layout { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px; }
        .card-instance { border-radius: 24px; overflow: hidden; transition: transform 0.3s, box-shadow 0.3s; cursor: pointer; position: relative; }
        .card-instance:hover { transform: translateY(-8px); box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
        .card-instance.locked { opacity: 0.6; cursor: not-allowed; }
        .card-instance.locked:hover { transform: none; }
        
        .card-cover { height: 200px; width: 100%; position: relative; background: linear-gradient(135deg, var(--primary), var(--secondary)); }
        .card-cover img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
        .card-instance:not(.locked):hover .card-cover img { transform: scale(1.1); }
        
        .card-badge { position: absolute; top: 12px; left: 12px; padding: 4px 12px; border-radius: 100px; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); font-size: 12px; font-weight: 600; border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; gap: 4px;}
        .card-body { padding: 20px; }
        .card-title { font-size: 18px; font-weight: 700; margin-bottom: 6px; }
        .card-desc { font-size: 13px; color: var(--text-muted); line-height: 1.5; }
        
        .locked-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; }
        .lock-icon { font-size: 32px; opacity: 0.8; color: #fff; }

        /* 详情页 */
        .detail-layout { display: flex; gap: 24px; border-radius: 24px; padding: 24px; margin-bottom: 24px; }
        .detail-cover { flex: 0 0 40%; border-radius: 20px; overflow: hidden; background: #111; }
        .detail-cover img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .detail-info { flex: 1; display: flex; flex-direction: column; justify-content: space-between; gap: 16px; }
        .detail-title { font-size: 32px; font-weight: 800; margin-bottom: 8px; }
        .detail-meta { font-size: 14px; color: var(--text-muted); line-height: 1.7; }
        .tag-row { display: flex; gap: 10px; margin-top: 8px; }
        .tag { padding: 4px 10px; background: rgba(255,255,255,0.08); border-radius: 999px; font-size: 12px; }

        /* 角色头像 (详情页) */
        .char-scroll { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 20px; scrollbar-width: none; }
        .char-item { flex: 0 0 auto; text-align: center; width: 80px; }
        .char-avatar { width: 80px; height: 80px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2); padding: 2px; margin-bottom: 8px; position: relative; background: linear-gradient(135deg, var(--primary), var(--secondary)); overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .char-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .char-name { font-size: 12px; color: var(--text-muted); }

        /* 身份栏 (Story Style) */
        .persona-strip-container { display: flex; gap: 16px; overflow-x: auto; padding: 10px 4px; scrollbar-width: none; }
        .persona-strip-container::-webkit-scrollbar { display: none; }
        .story-ring { flex: 0 0 auto; display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer; width: 64px; }
        .story-avatar-wrap { width: 56px; height: 56px; border-radius: 50%; padding: 2px; background: linear-gradient(45deg, var(--primary), var(--secondary)); position: relative; }
        .story-avatar-wrap.new-btn { background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; }
        .story-avatar-inner { width: 100%; height: 100%; border-radius: 50%; border: 2px solid var(--bg-deep); background: #222; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .story-avatar-inner img { width: 100%; height: 100%; object-fit: cover; }
        .story-name { font-size: 11px; color: var(--text-main); max-width: 60px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* 系统设置 */
        .settings-container { max-width: 600px; margin: 0 auto; }
        .setting-group { margin-bottom: 24px; padding: 24px; border-radius: 20px; }
        .input-label { display: block; margin-bottom: 8px; font-size: 13px; color: var(--text-muted); font-weight: 600; }
        .theme-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; margin-top: 12px; }
        .theme-btn { padding: 12px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.05); color: var(--text-main); cursor: pointer; transition: all 0.3s; font-size: 14px; font-weight: 600; }
        .theme-btn:hover { border-color: var(--primary); transform: translateY(-2px); }
        .theme-btn.active { background: var(--gradient-holo); border-color: transparent; color: white; }

        /* 游戏界面 */
        .game-container { position: fixed; inset: 0; z-index: 200; display: none; background-color: #000; overflow: hidden; }
        .game-bg { position: absolute; inset: 0; background-size: cover; background-position: center; filter: brightness(0.65); }
        .game-content { position: relative; z-index: 1; display: flex; flex-direction: column; justify-content: flex-end; height: 100%; padding: 20px 16px 28px; }
        .game-text-box { max-width: 900px; margin: 0 auto 16px; background: rgba(0,0,0,0.68); border-radius: 16px; padding: 16px 18px; color: #fff; min-height: 90px; font-size: 15px; line-height: 1.7; cursor: pointer; }
        .game-options { max-width: 900px; margin: 0 auto; display: flex; flex-wrap: wrap; gap: 10px; }
        .game-option-btn { padding: 10px 16px; border-radius: 999px; border: none; background: rgba(0,0,0,0.7); color: #fff; font-size: 14px; cursor: pointer; transition: background 0.2s, transform 0.1s; }
        .game-option-btn:hover { background: rgba(255,255,255,0.2); }
        .game-exit-btn { position: absolute; top: 14px; right: 16px; z-index: 2; padding: 8px 14px; border-radius: 999px; border: none; background: rgba(0,0,0,0.7); color: #fff; font-size: 13px; cursor: pointer; }

        /* 剧本上传 */
        .story-upload-area { margin-top: 30px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; }
        .file-btn { display: inline-block; padding: 10px 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; cursor: pointer; color: var(--text-muted); font-size: 13px; }

        /* 响应式 */
        @media (max-width: 768px) {
            .detail-layout { flex-direction: column; }
            .detail-cover { flex-basis: auto; height: 220px; }
            .dock-nav { width: 90%; justify-content: space-between; padding: 12px 20px; }
            .grid-layout { grid-template-columns: 1fr; }
            .game-content { padding: 16px 10px 24px; }
            .game-text-box { font-size: 14px; padding: 14px 14px; }
        }

        /* 弹窗样式 */
        .modal-overlay { position: fixed; inset: 0; z-index: 999; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; animation: fadeIn 0.2s; }
        .modal-card { width: 90%; max-width: 400px; padding: 24px; border-radius: 24px; background: var(--bg-deep); border: 1px solid var(--primary); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-btn { background: none; border: none; color: var(--text-main); font-size: 24px; cursor: pointer; }
        .modal-list { display: grid; gap: 12px; max-height: 300px; overflow-y: auto; }
        .persona-select-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; background: rgba(255,255,255,0.05); cursor: pointer; transition: all 0.2s; border: 1px solid transparent; }
        .persona-select-item:hover, .persona-select-item.active { background: rgba(255,255,255,0.1); border-color: var(--primary); }

        /* 新增：记忆回放框样式 */
        .log-container { background: rgba(0,0,0,0.1); border-radius: 12px; padding: 20px; height: 300px; overflow-y: auto; font-size: 14px; line-height: 1.8; white-space: pre-wrap; color: var(--text-muted); margin-top: 10px; }
        
        /* 新增：Toast 提示框样式 */
        #toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.85); color: #fff; padding: 12px 24px; border-radius: 50px; display: none; z-index: 300; backdrop-filter: blur(10px); border: 1px solid var(--primary); font-weight: bold; animation: popIn 0.3s; }
        @keyframes popIn { from { transform: translate(-50%, -40%); opacity: 0; } to { transform: translate(-50%, -50%); opacity: 1; }}
    </style>
</head>
<body data-theme="purple">
    <div class="aurora-bg"></div>
    <div id="toast"> 操作成功</div>
    
    <div class="login-page" id="loginPage">
        <div class="login-card glass-panel">
            <h1 class="login-title">INFINITE LOVE</h1>
            <p class="login-subtitle">Utopia note · 乌托邦手记</p>
            
            <div class="input-wrapper">
                <input type="text" class="input-modern" id="username" placeholder="请输入你的代号..." autocomplete="off">
            </div>
            
            <button class="btn-glow" onclick="enterHub()">
                <span style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                    连接神经元
                    <svg class="icon" viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                </span>
            </button>
        </div>
    </div>

    <div class="main-hub" id="mainHub">
        <div class="top-bar">
            <div class="user-pill glass-panel">
                <div class="avatar-small">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                </div>
                <span style="font-weight: 600; font-size: 14px;" id="displayName">旅行者</span>
            </div>

            <div class="resource-pill">
                <div class="res-item glass-panel" style="padding: 6px 12px; border-radius: 12px;">
                    <svg class="icon res-icon" viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                    <span>80</span>
                </div>
                <div class="res-item glass-panel" style="padding: 6px 12px; border-radius: 12px;">
                    <svg class="icon res-icon" style="color: #d946ef;" viewBox="0 0 24 24"><path d="M6 3h12l4 6-10 10L2 9h4z"/></svg>
                    <span>1250</span>
                </div>
            </div>
        </div>

        <div class="view-section active" id="view-hub">
            <h2 class="section-header">探索世界</h2>
            <div class="grid-layout">
                <div class="card-instance glass-panel" onclick="showInstanceDetail()">
                    <div class="card-cover">
                        <img src="https://images.unsplash.com/photo-1599707367072-cd6ad6cb3d2e?auto=format&fit=crop&w=600&q=80" alt="紫禁城">
                        <span class="card-badge">古代宫廷</span>
                    </div>
                    <div class="card-body">
                        <div class="card-title">紫禁城迷梦</div>
                        <div class="card-desc">权力与爱欲交织的深宫，你能否独善其身？</div>
                    </div>
                </div>

                <div class="card-instance glass-panel locked">
                    <div class="card-cover">
                        <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#fff;">
                            <svg class="icon" style="width:48px;height:48px;" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                        </div>
                        <span class="card-badge" style="background: rgba(0,0,0,0.8);">待解锁</span>
                    </div>
                    <div class="card-body">
                        <div class="card-title">???</div>
                        <div class="card-desc">完成当前副本解锁更多世界</div>
                    </div>
                    <div class="locked-overlay">
                        <svg class="icon lock-icon" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                        <div class="lock-text">需要 500 积分</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="view-section" id="view-detail">
            <button class="glass-panel" onclick="switchView('hub')" style="margin-bottom: 20px; padding: 10px 20px; border-radius: 12px; border:none; color:var(--text-main); cursor:pointer; display:flex; align-items:center; gap:8px;">
                <svg class="icon" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                返回
            </button>

            <div class="detail-layout glass-panel">
                <div class="detail-cover">
                    <img src="https://images.unsplash.com/photo-1599707367072-cd6ad6cb3d2e?auto=format&fit=crop&w=1200&q=80" alt="紫禁城迷梦封面">
                </div>
                <div class="detail-info">
                    <div>
                        <div class="detail-title" style="display:flex; align-items:center; gap:12px;">
                            紫禁城迷梦
                            <div onclick="openPersonaModal()" style="font-size:14px; padding:4px 10px; background:rgba(255,255,255,0.1); border-radius:20px; cursor:pointer; border:1px solid rgba(255,255,255,0.2); display:flex; align-items:center; gap:4px;">
                                <span id="currentPersonaLabel">未选人设</span>
                                <svg class="icon" style="width:14px;height:14px;" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"/></svg>
                            </div>
                        </div>
                        <div class="detail-meta">
                            作者：主神空间<br>
                            标签：
                            <div class="tag-row">
                                <span class="tag">古代宫廷</span>
                                <span class="tag">权谋</span>
                                <span class="tag">恋爱</span>
                            </div>
                            <div class="detail-desc">
                                穿越到明朝永乐年间，你成为了一名入宫的秀女。在这个金碧辉煌却暗流涌动的紫禁城中，每一步都可能是生死考验。
                            </div>
                        </div>
                    </div>
                    <div>
                        <div style="display:flex; gap:10px;">
                            <button class="btn-glow" style="flex:1" onclick="startGame('start')">
                                <svg class="icon" viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 1-4 4v14a3 3 0 0 1 3-3h7z"></path></svg> 
                                开始剧情
                            </button>
                            <button class="btn-glow" style="flex:1; background: rgba(16, 185, 129, 0.2);" onclick="startGame('continue')">
                                <svg class="icon" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                                继续剧情
                            </button>
                        </div>
                        <button class="btn-glow" onclick="startGame('endless')" style="width:100%; margin-top:10px; background: rgba(255,255,255,0.1);">
                            <svg class="icon" viewBox="0 0 24 24"><path d="M12 12c-2-3-5.5-4-8-2-2.5 2-2.5 6 0 8 2.5 2 6 1 8-2 2 3 5.5 4 8 2 2.5-2 2.5-6 0-8-2.5-2-6-1-8 2z"></path></svg>
                            无尽模式
                        </button>
                    </div>
                </div>
            </div>

            <div class="glass-panel" style="padding: 24px; border-radius: 24px; margin-bottom: 30px;">
                <h3 style="margin-bottom: 16px; font-weight: 700;">主要角色</h3>
                <div class="char-scroll">
                    <div class="char-item">
                        <div class="char-avatar">
                            <div style="display:flex;align-items:center;justify-content:center;height:100%;color:#fff;">
                                <svg class="icon" style="width:32px;height:32px;" viewBox="0 0 24 24"><path d="M2 4l3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"></path></svg>
                            </div>
                        </div>
                        <div class="char-name">夜幽皇子</div>
                    </div>
                    <div class="char-item">
                        <div class="char-avatar">
                            <div style="display:flex;align-items:center;justify-content:center;height:100%;color:#fff;">
                                <svg class="icon" style="width:32px;height:32px;" viewBox="0 0 24 24"><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"></polyline><line x1="13" y1="19" x2="19" y2="13"></line><line x1="16" y1="16" x2="20" y2="20"></line><line x1="19" y1="21" x2="21" y2="19"></line></svg>
                            </div>
                        </div>
                        <div class="char-name">侍卫云墨</div>
                    </div>
                    <div class="char-item">
                        <div class="char-avatar">
                            <div style="display:flex;align-items:center;justify-content:center;height:100%;color:#fff;">
                                <svg class="icon" style="width:32px;height:32px;" viewBox="0 0 24 24"><path d="M2 12c0-4.4 3.6-8 8-8 4.4 0 8 3.6 8 8 0 4.4-3.6 8-8 8-4.4 0-8-3.6-8-8z"></path><path d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"></path></svg>
                            </div>
                        </div>
                        <div class="char-name">神秘术士</div>
                    </div>
                </div>

            </div>

            <div class="glass-panel" style="padding: 24px; border-radius: 24px;">
                <h3 style="margin-bottom: 16px; font-weight: 700;"> 优秀剧情分享</h3>
                <div style="background: rgba(0,0,0,0.1); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 3px solid var(--primary);">
                    <div style="color: var(--primary); font-weight: 600; margin-bottom: 8px;">樱花落</div>
                    <div style="color: var(--text-muted); line-height: 1.6; font-size: 14px;">
                        "我在紫禁城遇到的侍卫云墨简直太温柔了！在我被人陷害时，他冒着生命危险为我作证。最后我们一起逃出皇宫，隐居山林的结局太美好了！"
                    </div>
                </div>
                <div style="background: rgba(0,0,0,0.1); padding: 16px; border-radius: 12px; border-left: 3px solid var(--primary);">
                    <div style="color: var(--primary); font-weight: 600; margin-bottom: 8px;">⚔️ 剑客行</div>
                    <div style="color: var(--text-muted); line-height: 1.6; font-size: 14px;">
                        "选择了皇子线，虽然他表面冷酷，但在深宫暗斗中始终保护我。最终他登基为帝，我成为皇后，但我们约定不忘初心的场景太催泪了..."
                    </div>
                </div>
            </div>
        </div>

        <div class="view-section" id="view-gallery">
            <h2 class="section-header">记忆回廊</h2>
            <div class="settings-container glass-panel setting-group">
                <div style="padding:10px;">
                    <p style="color:var(--text-muted); font-size:12px; margin-bottom:10px;">记录所有经历过的剧情片段</p>
                    <div id="storyLog" class="log-container">暂无记忆</div>
                    <button class="btn-glow" onclick="clearMemory()" style="margin-top:15px; background:rgba(239,68,68,0.5);">
                        <svg class="icon" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg> 
                        清空记忆
                    </button>
                </div>
            </div>
        </div>

        <div class="view-section" id="view-shop">
            <h2 class="section-header">道具商店</h2>
            <div class="settings-container glass-panel setting-group">
                <p style="color: var(--text-muted); line-height: 1.8;">
                    魅力口红、测谎仪、限定门票等道具即将上线...
                </p>
            </div>
        </div>

        <div class="view-section" id="view-persona">
            <h2 class="section-header">我的设定</h2>
            <div class="persona-container">
                <div class="glass-panel" style="border-radius: 20px; padding: 12px 16px; margin-bottom: 20px;">
                    <div class="persona-strip-container" id="persona-strip"></div>
                </div>

                <div class="glass-panel persona-form" style="margin-top: 16px; padding: 20px;">
                    <div class="input-wrapper">
                        <label class="input-label">姓名</label>
                        <input id="persona-name" class="input-modern" placeholder="角色名">
                    </div>
                    <div class="input-wrapper">
                        <label class="input-label">设定</label>
                        <textarea id="persona-desc" class="input-modern" style="min-height: 100px;" placeholder="人物小传..."></textarea>
                    </div>
                    <div class="input-wrapper">
                        <label class="input-label">头像</label>
                        <div style="display:flex; align-items:center; gap:16px;">
                            <div class="persona-avatar-slot" id="persona-avatar-slot" onclick="triggerAvatarUpload()" style="width: 60px; height: 60px; background: rgba(255,255,255,0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden;">
                                <img id="persona-avatar-preview" style="display:none; width:100%; height:100%; object-fit:cover;">
                                <span id="persona-placeholder" style="font-size: 10px;">点击上传</span>
                            </div>
                            <span style="font-size:12px; color:var(--text-muted);">仅本地保存</span>
                        </div>
                        <input type="file" id="persona-avatar-input" accept="image/*" style="display:none;" onchange="onAvatarFileChange(event)">
                    </div>
        
        <div class="view-section" id="view-settings">
            <h2 class="section-header">系统设置</h2>
            
            <div class="settings-container glass-panel setting-group">
                <h3 style="margin-bottom: 20px; font-size: 18px;">API 连接配置</h3>
                
                <div class="input-wrapper">
                    <label class="input-label">配置名称</label>
                    <input type="text" class="input-modern" id="apiName" placeholder="例如：我的 OpenAI 配置">
                </div>
                
                <div class="input-wrapper">
                    <label class="input-label">API URL 代理地址</label>
                    <input type="text" class="input-modern" id="apiUrl" placeholder="例如：https://api.openai.com/v1">
                </div>
                
                <div class="input-wrapper">
                    <label class="input-label">API 密钥 (Key)</label>
                    <input type="password" class="input-modern" id="settingsApiKey" placeholder="sk-...">
                </div>
                <div class="input-wrapper">
                    <label class="input-label">模型选择</label>
                    <select class="input-modern" id="apiModel" style="cursor: pointer;">
                        <option value="">-- 请先测试连接获取模型列表 --</option>
                    </select>
                </div>

                <div style="display: flex; gap: 12px;">
                    <button class="btn-glow" style="flex: 1;" onclick="testApiConnection()">
                        测试连接
                    </button>
                    <button class="btn-glow" style="flex: 1;" onclick="saveApiConfig()">
                        保存配置
                    </button>
                </div>
                
                <div id="apiTestResult" style="margin-top: 12px; padding: 12px; border-radius: 8px; font-size: 13px; display: none;"></div>
            </div>

            <div class="settings-container glass-panel setting-group" style="margin-top: 24px;">
                <h3 style="margin-bottom: 20px; font-size: 18px;">剧本管理</h3>
                <div style="color: var(--text-muted); font-size: 13px; margin-bottom: 12px;">
                    上传编辑器导出的 JSON 文件来替换默认剧情。
                </div>
                
                <div style="display:flex; gap:10px; align-items:center;">
                    <label class="file-btn">
                         上传剧本文件
                        <input type="file" id="storyFileUpload" accept=".json" style="display:none;" onchange="handleStoryUpload(event)">
                    </label>
                    <button class="btn-glow" style="background: rgba(239, 68, 68, 0.5); width: auto;" onclick="resetStory()">
                         恢复默认
                    </button>
                </div>
                <div id="storyUploadMsg" style="margin-top:8px; font-size:12px; color:#10b981;"></div>
            </div>

            <div class="settings-container glass-panel setting-group" style="margin-top: 24px;">
                <h3 style="margin-bottom: 20px; font-size: 18px;">主题风格</h3>
                <div class="theme-grid">
                    <button class="theme-btn active" data-theme="purple" onclick="changeTheme('purple')">霓虹紫</button>
                    <button class="theme-btn" data-theme="reader" onclick="changeTheme('reader')" style="background:#fdfbf7; color:#263238; border:1px solid #b0bec5;">纸间黛蓝</button>
                </div>
            </div>
        </div>

        <div class="input-wrapper" style="margin-top:24px; padding-top:20px; border-top:1px solid rgba(255,255,255,0.1);">
                        <label class="input-label">字体美化 (输入字体链接)</label>
                        <div style="display:flex; gap:10px;">
                            <input id="customFontUrl" class="input-modern" placeholder="粘贴 .woff2 或 .ttf 链接">
                            <button class="btn-glow" style="width:auto; padding:0 20px;" onclick="applyCustomFont()">应用</button>
                        </div>
                        <p style="font-size:12px; color:var(--text-muted); margin-top:5px;">支持 Google Fonts 链接或直接文件地址。</p>
                    </div>

                    <div class="persona-actions" style="margin-top: 20px;">
                        <button class="btn-glow" style="flex:1;" onclick="savePersona()">保存设定</button>
                    </div>
                </div>
            </div>
        </div>
    
        <div class="dock-nav glass-panel">
            <div class="dock-item active" onclick="switchView('hub')" title="副本中心">
                <svg class="icon dock-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
            </div>
            <div class="dock-item" onclick="switchView('gallery')" title="记忆回廊">
                <svg class="icon dock-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
            </div>
            <div class="dock-item" onclick="switchView('shop')" title="道具商店">
                <svg class="icon dock-icon" viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
            </div>
            <div class="dock-item" onclick="switchView('persona')" title="我的设定">
                <svg class="icon dock-icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            </div>
            <div class="dock-item" onclick="switchView('settings')" title="系统设置">
                <svg class="icon dock-icon" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
            </div>
    <div id="gameContainer" class="game-container">
        <div id="gameBg" class="game-bg"></div>
        <button class="game-exit-btn" onclick="saveProgress(true)" style="right: 80px; background: rgba(16, 185, 129, 0.6);"> 存档</button>       
        <button class="game-exit-btn" onclick="exitGame()">退出</button>
        <div class="game-content">
            <div id="gameTextBox" class="game-text-box">
                <span id="gameText"></span>
            </div>
            <div id="gameOptions" class="game-options"></div>
        </div>
    </div>

    <div id="personaModal" class="modal-overlay" style="display:none;">
        <div class="modal-card glass-panel">
            <div class="modal-header">
                <h3> 选择你的身份</h3>
                <button class="close-btn" onclick="closePersonaModal()">×</button>
            </div>
            <div id="modalPersonaList" class="modal-list">
                </div>
            <div id="modalEmptyState" style="display:none; text-align:center; padding:20px;">
                <p style="color:var(--text-muted); margin-bottom:15px;">暂无可用人设</p>
                <button class="btn-glow" onclick="goToPersonaCreate()"> 去创建新人设</button>
            </div>
        </div>
    </div>

    <script>
        const USERNAME_STORAGE = 'infinite.username';
        const PERSONA_STORAGE = 'infinite.personas';
        const STORY_STORAGE = 'infinite.customStory';
        const FONT_STORAGE = 'infinite.customFont';

        let currentPersonaId = null;
        let currentSceneId = null; // 全局记录当前场景 ID

        // 打字机状态
        let typingTimer = null;
        let typingIndex = 0;
        let typingText = '';
        let isTyping = false;

        // 默认剧本数据（支持 fixed / ai 混合）
        const storyData = {
            start: {
                type: 'fixed',
                bg: 'https://images.unsplash.com/photo-1599707367072-cd6ad6cb3d2e?auto=format&fit=crop&w=1200&q=80',
                text:
`夜风从宫墙之上吹过，檐角的金铃被吹得轻轻作响。你随同新入宫的秀女队伍缓缓前行，脚下是被岁月磨得发亮的青石板，仿佛每一步都踩在前人留下的秘密上。\n\n远处乐声隐约，宫灯一盏盏点亮，金碧辉煌却让人心底发寒。你感觉到有目光在暗处注视——是那位传闻冷心冷面的皇子，还是站在阴影里的侍卫？今晚，将是你命运真正开始的时刻。`,
                options: [
                    { text: '顺从领路宫女，安静地走完入宫流程', nextScene: 'followMaid' },
                    { text: '偷偷回头，看一眼站在暗处的侍卫', nextScene: 'lookGuard' }
                ]
            },
            followMaid: {
                type: 'fixed',
                bg: 'https://images.unsplash.com/photo-1563298723-dcfebaa392e3?auto=format&fit=crop&w=1200&q=80',
                text:
`你压下心中所有的好奇，只是低头跟在领路宫女身后。她的步伐轻快却不失规矩，显然已经习惯了把新人送往不同宫院的流程。\n\n路过偏殿时，你听见门后传来压低的争吵声，字句里提到“选秀名单”和“有人动了手脚”。宫女猛地加快了脚步，仿佛害怕你听见更多。你隐约意识到，自己能否留在这座宫城里，早已不是单纯的运气问题。`,
                options: [
                    { text: '假装没听见，先稳住脚跟', nextScene: 'safeEnd' },
                    { text: '记下这些话，暗中查清真相', nextScene: 'plotBeginAi' }
                ]
            },
            lookGuard: {
                type: 'fixed',
                bg: 'https://images.unsplash.com/photo-1558985303-38eab1f8e51c?auto=format&fit=crop&w=1200&q=80',
                text:
`你不顾宫规，还是回头看了一眼。那名侍卫半隐在宫灯照不到的阴影里，盔甲没有完全扣好，似乎刚刚才从某处急匆匆赶来。\n\n四目相对的一瞬，他明显愣了一下，随即很快低头行礼，仿佛从未与人对视。可你清楚地看到，他默默对你做了一个极轻微的手势——像是在提醒你，今晚不要独自离开人群。`,
                options: [
                    { text: '记住这位侍卫，悄悄跟在队伍中间', nextScene: 'plotBeginAi' },
                    { text: '无视警告，趁人不注意时绕近宫墙', nextScene: 'dangerEnd' }
                ]
            },
            // 使用 AI 续写的场景示例
            plotBeginAi: {
                type: 'ai',
                bg: 'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1200&q=80',
                prompt: '继续这个紫禁城开局故事：主角在夜色中意识到自己被卷入权谋斗争之中，语气偏抒情、第一人称，控制在 250 字以内。',
                options: [
                    { text: '本章结束，回到主神空间', nextScene: null }
                ]
            },
            safeEnd: {
                type: 'fixed',
                bg: 'https://images.unsplash.com/photo-1578301978018-3005759f48f9?auto=format&fit=crop&w=1200&q=80',
                text:
`你选择把所有不安先压在心底，只求在这陌生的宫城安稳活下去。或许这是最安全的做法，但也是最容易被时代遗忘的路径。\n\n当寝宫的门在你身后关上，你忽然有种被世界隔绝的错觉。也许，真正决定命运的机会，已经悄悄从你指缝间溜走。`,
                options: [
                    { text: '结束体验，返回主神空间', nextScene: null }
                ]
            },
            dangerEnd: {
                type: 'fixed',
                bg: 'https://images.unsplash.com/photo-1526498460520-4c246339dccb?auto=format&fit=crop&w=1200&q=80',
                text:
`你趁宫女回头点人数的空档，悄悄往宫墙阴影里退去。夜风比想象中更冷，墙角积雪未融，踩上去发出细碎的声响。\n\n还没等你看清前路，一只冰冷的手已经扣在你肩上——那是巡夜的禁军。他没有多问，只是低声提醒你：“今晚第一次犯规，只算你迷路。”你被重新带回队伍，却知道自己已经被这座宫城真正记住了。`,
                options: [
                    { text: '结束体验，返回主神空间', nextScene: null }
                ]
            }
        };

        // 当前生效剧本（可被自定义 JSON 覆盖）
        let activeStoryData = storyData;

        // 初始化
        function init() {
            loadApiConfig();
            loadTheme();
            loadCustomFont(); // 加载自定义字体
            loadCustomStory(); // 这里会自动加载你上传的剧本

            // 用户名自动回填 + 自动进入主界面
            const nameInput = document.getElementById('username');
            const savedName = localStorage.getItem(USERNAME_STORAGE);
            if (savedName) {
                nameInput.value = savedName;
                document.getElementById('displayName').textContent = savedName;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainHub').style.display = 'block';
                switchView('hub');
            }

            nameInput.addEventListener('blur', () => {
                const v = nameInput.value.trim();
                if (v) localStorage.setItem(USERNAME_STORAGE, v);
            });

            initPersonas();
        }

        // === 新增：字体美化逻辑 ===
        function applyCustomFont() {
            const url = document.getElementById('customFontUrl').value.trim();
            if(!url) return;
            
            // 简单处理：如果是CSS链接或文件链接
            if (url.endsWith('.css') || url.includes('fonts.googleapis.com')) {
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = url;
                document.head.appendChild(link);
            } else {
                const style = document.createElement('style');
                style.innerHTML = `
                    @font-face { font-family: 'UserCustomFont'; src: url('${url}'); }
                    body { font-family: 'UserCustomFont', var(--font-main) !important; }
                `;
                document.head.appendChild(style);
            }
            
            localStorage.setItem(FONT_STORAGE, url);
            showToastMsg("✨ 字体已应用");
        }

        function loadCustomFont() {
            const url = localStorage.getItem(FONT_STORAGE);
            if(url) {
                document.getElementById('customFontUrl').value = url;
                const style = document.createElement('style');
                // 这里做一个通用处理，默认如果是文件就用 UserCustomFont
                if (url.endsWith('.css') || url.includes('fonts.googleapis.com')) {
                     const link = document.createElement('link');
                     link.rel = 'stylesheet';
                     link.href = url;
                     document.head.appendChild(link);
                } else {
                    style.innerHTML = `
                        @font-face { font-family: 'UserCustomFont'; src: url('${url}'); }
                        body { font-family: 'UserCustomFont', var(--font-main) !important; }
                    `;
                    document.head.appendChild(style);
                }
            }
        }

        // 切换视图逻辑
        function switchView(viewName) {
            // 隐藏所有视图
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            
            // 显示目标视图
            const target = document.getElementById('view-' + viewName);
            if (target) target.classList.add('active');

            // 如果是打开相册，加载存档列表
            if (viewName === 'gallery') {
                renderGallery();
            }

            // 更新底部 Dock 激活状态
            document.querySelectorAll('.dock-item').forEach(el => el.classList.remove('active'));
            
            // 根据视图更新激活状态
            const dockItems = document.querySelectorAll('.dock-item');
            const viewMap = {
                'hub': 0,
                'gallery': 1,
                'shop': 2,
                'persona': 3,
                'settings': 4
            };
            
            const index = viewMap[viewName];
            if (index !== undefined && dockItems[index]) {
                dockItems[index].classList.add('active');
            }
        }

        // 登录逻辑
        function enterHub() {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                // 简单的晃动动画
                const card = document.querySelector('.login-card');
                card.style.transform = 'translateX(10px)';
                setTimeout(() => card.style.transform = 'translateX(0)', 100);
                setTimeout(() => card.style.transform = 'translateX(-10px)', 200);
                setTimeout(() => card.style.transform = 'translateX(0)', 300);
                return;
            }
            
            document.getElementById('displayName').textContent = username;
            localStorage.setItem(USERNAME_STORAGE, username);
            
            // 切换界面
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainHub').style.display = 'block';
            
            // 默认显示副本页
            switchView('hub');
        }

        // 显示副本详情
        function showInstanceDetail() {
            switchView('detail');
        }

        // ===== 游戏流程 =====
        function startGame(mode) {
            // 如果是无尽模式或新开始，必须检查人设
            if (mode === 'start' || mode === 'endless') {
                if (!currentPersonaId) {
                    // 没有选人设，弹出选择框
                    openPersonaModal(mode); // 把模式传过去，选完后自动开始
                    return;
                }
            }

            const mainHub = document.getElementById('mainHub');
            const game = document.getElementById('gameContainer');
            const dock = document.querySelector('.dock-nav');

            if (mainHub) mainHub.style.display = 'none';
            if (dock) dock.style.display = 'none';
            if (game) game.style.display = 'block';
            
            // 更新顶部显示的名字（如果有）
            updateGameDisplayName();

            // 1. 如果是点击“继续游戏”
            if (mode === 'continue') {
                const saveRaw = localStorage.getItem('infinite.save');
                if (saveRaw) {
                    const save = JSON.parse(saveRaw);
                    // 恢复记忆
                    activeStoryData.memory = save.memory || ''; 
                    loadScene(save.currentSceneId);
                    return;
                } else {
                    alert("没有找到存档，将开始新游戏");
                }
            }

            // 2. 如果是新游戏，清空记忆
            activeStoryData.memory = "故事开端。"; // 初始化记忆
            localStorage.removeItem('infinite.save'); // 清除旧档

            // 尝试从 main_story 获取起始节点
            let firstScene = 'start';
            if (mode === 'endless' && activeStoryData['plotBeginAi']) {
                firstScene = 'plotBeginAi';
            } else if (!activeStoryData[firstScene]) {
                // 如果没有 'start'，尝试找第一个Key
                const keys = Object.keys(activeStoryData);
                if (keys.length > 0) firstScene = keys[0];
            }
            
            loadScene(firstScene);
        }

        function exitGame() {
            const mainHub = document.getElementById('mainHub');
            const game = document.getElementById('gameContainer');
            const dock = document.querySelector('.dock-nav');

            if (game) game.style.display = 'none';
            if (mainHub) mainHub.style.display = 'block';
            if (dock) dock.style.display = 'flex';

            // 返回副本详情
            switchView('detail');
        }

        // 修改：存档同时保存到历史记录
        function saveProgress(showToast = false) {
            if (!activeStoryData) return;
            const saveState = {
                currentSceneId: currentSceneId || 'start',
                memory: activeStoryData.memory || "",
                timestamp: Date.now()
            };
            
            // 1. 保存当前进度（用于“继续游戏”）
            localStorage.setItem('infinite.save', JSON.stringify(saveState));

            // 2. 保存到记忆回廊（用于展示列表）
            const allSaves = JSON.parse(localStorage.getItem('infinite.all_saves') || '{}');
            // 暂时使用固定 key 'dungeon_forbidden_city'，实际项目可以用动态 ID
            allSaves['dungeon_forbidden_city'] = {
                dungeonName: "紫禁城迷梦",
                lastPlayed: new Date().toLocaleString(),
                memory: activeStoryData.memory || "暂无记忆...",
                sceneId: currentSceneId || 'start'
            };
            localStorage.setItem('infinite.all_saves', JSON.stringify(allSaves));

            if (showToast) showToastMsg("💾 进度已保存至记忆回廊");
        }

        // 新增：渲染记忆回廊
        function renderGallery() {
            const container = document.getElementById('storyLog'); 
            if (!container) return;

            const allSaves = JSON.parse(localStorage.getItem('infinite.all_saves') || '{}');
            const keys = Object.keys(allSaves);

            if (keys.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:20px;">暂无探索记录</div>';
                return;
            }

            let html = '';
            keys.forEach(key => {
                const save = allSaves[key];
                html += `
                    <div style="background:var(--glass-surface); border-radius:12px; padding:16px; margin-bottom:12px; border-left:4px solid var(--primary); box-shadow:var(--shadow-card);">
                        <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                            <span style="font-weight:bold; font-size:16px; color:var(--text-main);">${save.dungeonName || '未知副本'}</span>
                            <span style="font-size:12px; color:var(--text-muted);">${save.lastPlayed}</span>
                        </div>
                        <div style="font-size:13px; color:var(--text-main); line-height:1.6; margin-bottom:12px; max-height:80px; overflow:hidden; text-overflow:ellipsis;">
                            ${save.memory.slice(-100)}...
                        </div>
                        <div style="text-align:right;">
                            <button class="btn-glow" style="padding:6px 16px; font-size:12px; width:auto;" onclick="loadGameFromGallery('${key}')">
                                ⚡ 继续探索
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.className = ''; 
            container.style.height = 'auto';
            container.style.maxHeight = '60vh';
            container.style.overflowY = 'auto';
            container.innerHTML = html;
        }

        // 新增：从回廊加载
        function loadGameFromGallery(saveKey) {
            const allSaves = JSON.parse(localStorage.getItem('infinite.all_saves') || '{}');
            const save = allSaves[saveKey];
            if (save) {
                // 恢复内存状态
                activeStoryData.memory = save.memory;
                // 跳转并开始
                loadScene(save.sceneId);
                
                // 界面切换
                document.getElementById('mainHub').style.display = 'none';
                document.querySelector('.dock-nav').style.display = 'none';
                document.getElementById('gameContainer').style.display = 'block';
            }
        }

        async function loadScene(sceneId) {
            // 更新全局进度并自动存档
            currentSceneId = sceneId;
            saveProgress(false); // 自动存档不弹提示

            let scene = activeStoryData[sceneId];
            const bgEl = document.getElementById('gameBg');
            const optionsEl = document.getElementById('gameOptions');

            // 容错：如果是 AI 生成的临时后续 ID，但本地没有数据，我们需要在这里构造一个临时的 AI 请求
            if (!scene && sceneId.startsWith('ai_')) {
                scene = {
                    type: 'ai',
                    prompt: `（接续剧情）请继续刚才的故事。场景ID: ${sceneId}。`,
                    bg: ''
                };
            }

            if (!scene) {
                alert('剧本结束或场景丢失：' + sceneId);
                exitGame();
                return;
            }

            if (bgEl && scene.bg) {
                bgEl.style.backgroundImage = `url(${scene.bg})`;
            }

            if (optionsEl) optionsEl.innerHTML = '';

            // fixed 文本：直接打字机
            if (!scene.type || scene.type === 'fixed') {
                typeWriter(scene.text || '');
                // 渲染固定选项
                if (scene.options && scene.options.length) {
                    scene.options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = 'game-option-btn';
                        btn.textContent = opt.text || opt.label; 
                        btn.onclick = () => {
                            if (opt.nextScene) {
                                loadScene(opt.nextScene);
                            } else {
                                exitGame();
                            }
                        };
                        optionsEl.appendChild(btn);
                    });
                }
                return;
            }

            // ai 文本：先显示 loading，再请求 OpenAI
            if (scene.type === 'ai') {
                const textEl = document.getElementById('gameText');
                if (textEl) {
                    textEl.innerHTML = '⚡ 正在连接神经元...<br><span style="font-size:12px;opacity:0.6;">正在生成剧情...</span>';
                }

                const generated = await generateAiSceneText(sceneId, scene);
                
                // 如果生成失败，generated 会是错误信息的字符串
                if (typeof generated === 'string' && generated.startsWith('❌')) {
                    typeWriter(generated); // 显示错误信息
                    // 给个重试按钮
                    const btn = document.createElement('button');
                    btn.className = 'game-option-btn';
                    btn.textContent = '重试';
                    btn.onclick = () => loadScene(sceneId);
                    optionsEl.appendChild(btn);
                    return;
                }

                const finalText = generated.text || (typeof generated === 'string' ? generated : 'AI 生成了空内容');

                typeWriter(finalText);

                // 如果 AI 返回了新的选项，替换当前 options
                if (generated.options && Array.isArray(generated.options) && generated.options.length) {
                    optionsEl.innerHTML = '';
                    generated.options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = 'game-option-btn';
                        btn.textContent = opt.text;
                        btn.onclick = () => {
                            // 这里 AI 生成的 nextScene 可能是 null 或者一个新的 ID
                            // 如果是 null，我们假设它是一个新的 AI 节点
                            let nextId = opt.nextScene;
                            if (!nextId || nextId === 'null') {
                                nextId = 'ai_next_' + Date.now();
                                // 临时存入 activeStoryData 以便 loadScene 能找到上下文（这里简化处理，只传 prompt）
                                activeStoryData[nextId] = {
                                    type: 'ai',
                                    bg: scene.bg, // 沿用背景
                                    prompt: `用户选择了：${opt.text}。请根据这个选择继续剧情。`
                                };
                            }
                            loadScene(nextId);
                        };
                        optionsEl.appendChild(btn);
                    });
                } else {
                    // AI 没返回选项，给默认
                    const btn = document.createElement('button');
                    btn.className = 'game-option-btn';
                    btn.textContent = '继续';
                    btn.onclick = () => loadScene('ai_next_' + Date.now());
                    optionsEl.appendChild(btn);
                }
            }
        }

        function typeWriter(text) {
            const textEl = document.getElementById('gameText');
            if (!textEl) return;

            if (typingTimer) clearTimeout(typingTimer);
            typingText = text;
            typingIndex = 0;
            isTyping = true;
            textEl.textContent = '';

            const step = () => {
                if (!isTyping) return;
                if (typingIndex >= typingText.length) {
                    textEl.textContent = typingText;
                    isTyping = false;
                    return;
                }
                textEl.textContent += typingText.charAt(typingIndex);
                typingIndex += 1;
                typingTimer = setTimeout(step, 30);
            };

            step();
        }

        function skipTyping() {
            if (!isTyping) return;
            const textEl = document.getElementById('gameText');
            if (!textEl) return;
            if (typingTimer) clearTimeout(typingTimer);
            isTyping = false;
            textEl.textContent = typingText;
        }
        
        // API 配置保存
        function saveApiConfig() {
            const apiName = document.getElementById('apiName').value.trim();
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const apiKey = document.getElementById('settingsApiKey').value.trim();
            const apiModel = document.getElementById('apiModel').value.trim();
            
            if (!apiName || !apiUrl || !apiKey) {
                alert('⚠️ 请填写完整的 API 配置信息');
                return;
            }
            
            const config = {
                name: apiName,
                url: apiUrl,
                key: apiKey,
                model: apiModel || 'gpt-3.5-turbo'
            };
            
            localStorage.setItem('apiConfig', JSON.stringify(config));
            
            // 保存成功反馈
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '✅ 配置已保存';
            btn.style.background = '#10b981';
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = '';
            }, 2000);
        }

        // 加载 API 配置
        function loadApiConfig() {
            const savedConfig = localStorage.getItem('apiConfig');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    document.getElementById('apiName').value = config.name || '';
                    document.getElementById('apiUrl').value = config.url || '';
                    document.getElementById('settingsApiKey').value = config.key || '';
                    
                    // 如果有保存的模型，添加到下拉框
                    if (config.model) {
                        const modelSelect = document.getElementById('apiModel');
                        // 如果列表里没有这个选项，动态加一个
                        if (!Array.from(modelSelect.options).some(opt => opt.value === config.model)) {
                             const option = document.createElement('option');
                             option.value = config.model;
                             option.textContent = config.model;
                             modelSelect.appendChild(option);
                        }
                        modelSelect.value = config.model;
                    }
                } catch (e) {
                    console.error('Config load failed', e);
                }
            }
        }
        // 测试 API 连接并获取模型列表
        async function testApiConnection() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const apiKey = document.getElementById('settingsApiKey').value.trim();
            const resultDiv = document.getElementById('apiTestResult');
            const modelSelect = document.getElementById('apiModel');

            if (!apiUrl || !apiKey) {
                showApiTestResult(' 请先填写 API URL 和 Key', 'error');
                return;
            }

            showApiTestResult('🔄 正在测试连接...', 'loading');

            try {
                // 尝试获取模型列表
                // 兼容：有些代理需要 /v1/models，有些是 /models
                let modelsUrl = apiUrl.replace(/\/$/, '');
                if (modelsUrl.endsWith('/v1')) modelsUrl = modelsUrl.replace(/\/v1$/, '');
                if (modelsUrl.endsWith('/chat/completions')) modelsUrl = modelsUrl.replace(/\/chat\/completions$/, '');
                modelsUrl += '/models';
                
                const res = await fetch(modelsUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + apiKey,
                        'Content-Type': 'application/json'
                    }
                });

                if (!res.ok) {
                    const errorText = await res.text();
                    showApiTestResult(` 连接失败: ${res.status} ${res.statusText}`, 'error');
                    console.error('API Error:', errorText);
                    return;
                }

                const data = await res.json();
                
                if (data.data && Array.isArray(data.data)) {
                    // 成功获取模型列表
                    const models = data.data;
                    showApiTestResult(` 连接成功！找到 ${models.length} 个可用模型`, 'success');
                    
                    // 填充模型下拉框
                    modelSelect.innerHTML = '<option value="">-- 请选择模型 --</option>';
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = model.id;
                        modelSelect.appendChild(option);
                    });

                    // 如果之前保存过模型，自动选中
                    const savedConfig = localStorage.getItem('apiConfig');
                    if (savedConfig) {
                        try {
                            const config = JSON.parse(savedConfig);
                            if (config.model) {
                                modelSelect.value = config.model;
                            }
                        } catch (e) {}
                    }
                } else {
                    showApiTestResult('✅ 连接成功！但未能获取模型列表，请手动输入模型名', 'warning');
                }
            } catch (error) {
                showApiTestResult(` 网络错误: ${error.message}`, 'error');
                console.error('Fetch error:', error);
            }
        }

        function showApiTestResult(message, type) {
            const resultDiv = document.getElementById('apiTestResult');
            if (!resultDiv) return;

            const colors = {
                success: 'background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.4); color: #10b981;',
                error: 'background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); color: #ef4444;',
                warning: 'background: rgba(245, 158, 11, 0.2); border: 1px solid rgba(245, 158, 11, 0.4); color: #f59e0b;',
                loading: 'background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); color: #3b82f6;'
            };

            resultDiv.style.cssText = colors[type] || colors.loading;
            resultDiv.textContent = message;
            resultDiv.style.display = 'block';
        }

        // 主题切换（v20 版本的主题系统）
        function changeTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            // 更新主题按钮状态
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-theme') === theme) {
                    btn.classList.add('active');
                }
            });
        }

        // 加载主题
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'purple';
            changeTheme(savedTheme);
        }

        // ===== 个人设定：本地多档位 + 头像上传 =====
        function loadPersonas() {
            try {
                const raw = localStorage.getItem(PERSONA_STORAGE);
                if (!raw) return [];
                const list = JSON.parse(raw);
                return Array.isArray(list) ? list : [];
            } catch (e) {
                return [];
            }
        }

        function savePersonas(list) {
            localStorage.setItem(PERSONA_STORAGE, JSON.stringify(list));
        }

        function initPersonas() {
            renderPersonaStrip();
            
            // 游戏文本区域点击：正在打字时跳过动画
            const box = document.getElementById('gameTextBox');
            if (box) {
                box.addEventListener('click', () => {
                    if (isTyping) {
                        skipTyping();
                    }
                });
            }
        }
        
        // ==========================================
        //  修复版：身份栏渲染 (支持高亮 + 新建按钮)
        // ==========================================
        function renderPersonaStrip() {
            const strip = document.getElementById('persona-strip');
            if (!strip) return;
            
            strip.className = 'persona-strip-container'; 
            strip.innerHTML = '';

            // 1. 【固定添加】第一个圈圈：“+ 新身份”
            const newBtn = document.createElement('div');
            newBtn.className = 'story-ring';
            newBtn.onclick = () => resetPersonaForm(); 
            // 如果是新建模式 (currentPersonaId 为 null)，给个高亮
            const newActive = currentPersonaId === null ? 'border: 2px solid var(--primary);' : '';

            newBtn.innerHTML = `
                <div class="story-avatar-wrap new-btn" style="${newActive}">
                    <div class="story-avatar-inner">
                        <span style="font-size:24px; color:var(--text-main);">+</span>
                    </div>
                </div>
                <div class="story-name">新身份</div>
            `;
            strip.appendChild(newBtn);

            // 2. 【渲染列表】读取保存的身份
            const list = loadPersonas();
            list.forEach((p) => {
                const item = document.createElement('div');
                item.className = 'story-ring';
                item.onclick = () => loadPersonaDetail(p); 
                
                const imgContent = p.avatar 
                    ? `<img src="${p.avatar}">` 
                    : `<span style="font-size:20px">👤</span>`;

                // 选中高亮逻辑
                const isSelected = (currentPersonaId === p.id);
                const activeStyle = isSelected ? 'border: 2px solid var(--primary); transform: scale(1.1); transition: all 0.2s;' : '';

                item.innerHTML = `
                    <div class="story-avatar-wrap" style="${activeStyle}">
                        <div class="story-avatar-inner">
                            ${imgContent}
                        </div>
                    </div>
                    <div class="story-name">${p.name || '未命名'}</div>
                `;
                strip.appendChild(item);
            });
        }

        // ==========================================
        //  修复版：保存逻辑 (含异常处理 + 更新旧档)
        // ==========================================
        function savePersona() {
            const name = document.getElementById('persona-name').value.trim();
            const desc = document.getElementById('persona-desc').value.trim();
            const imgEl = document.getElementById('persona-avatar-preview');
            // 只有显示的图片才算有效
            const avatar = (imgEl.style.display !== 'none' && imgEl.src) ? imgEl.src : '';
            
            if (!name) {
                showToastMsg("❌ 至少起个名字吧~");
                return;
            }

            let list = loadPersonas();

            try {
                if (currentPersonaId) {
                    // --- 情况A：修改已有身份 ---
                    const index = list.findIndex(p => p.id === currentPersonaId);
                    if (index !== -1) {
                        list[index] = { ...list[index], name, desc, avatar };
                        showToastMsg("💾 身份信息已更新");
                    }
                } else {
                    // --- 情况B：创建新身份 ---
                    const newId = Date.now();
                    const newP = { id: newId, name, desc, avatar };
                    list.push(newP);
                    currentPersonaId = newId; // 保存后自动选中它
                    showToastMsg("✨ 新身份已创建");
                }

                savePersonas(list);
                renderPersonaStrip(); // 刷新顶部栏状态

            } catch (e) {
                // 捕获存储满的错误
                if (e.name === 'QuotaExceededError') {
                    alert(" 保存失败：图片太大了！\n浏览器存不下了，请换张小图或者不传头像。");
                } else {
                    console.error(e);
                    alert("保存出错：" + e.message);
                }
            }
        }

        // 切换到：新建模式
        function resetPersonaForm() {
            document.getElementById('persona-name').value = '';
            document.getElementById('persona-desc').value = '';
            document.getElementById('persona-avatar-preview').style.display = 'none';
            document.getElementById('persona-avatar-preview').src = '';
            document.getElementById('persona-placeholder').style.display = 'block';
            
            currentPersonaId = null; // null 代表新建
            
            showToastMsg(" 切换至新建模式");
            renderPersonaStrip();
        }

        // 切换到：查看模式
        function loadPersonaDetail(p) {
            document.getElementById('persona-name').value = p.name || '';
            document.getElementById('persona-desc').value = p.desc || '';
            currentPersonaId = p.id; 
            
            if (p.avatar) {
                const img = document.getElementById('persona-avatar-preview');
                img.src = p.avatar;
                img.style.display = 'block';
                document.getElementById('persona-placeholder').style.display = 'none';
            } else {
                document.getElementById('persona-avatar-preview').style.display = 'none';
                document.getElementById('persona-placeholder').style.display = 'block';
            }
            
            renderPersonaStrip(); // 刷新高亮
        }
        
        // ==========================================
        //  修复版：图片压缩 (防止存不下)
        // ==========================================
        function onAvatarFileChange(e) {
             const file = e.target.files[0];
             if(!file) return;

             // 提示一下大文件
             if (file.size > 2 * 1024 * 1024) {
                 showToastMsg(" 图片较大，正在压缩...");
             }

             const reader = new FileReader();
             reader.onload = function(evt) {
                 const img = new Image();
                 img.src = evt.target.result;
                 img.onload = function() {
                     // 创建 Canvas 压缩图片
                     const canvas = document.createElement('canvas');
                     const ctx = canvas.getContext('2d');
                     
                     // 限制最大宽高为 300px (头像够用了)
                     const MAX_SIZE = 300;
                     let width = img.width;
                     let height = img.height;
                     
                     if (width > height) {
                         if (width > MAX_SIZE) {
                             height *= MAX_SIZE / width;
                             width = MAX_SIZE;
                         }
                     } else {
                         if (height > MAX_SIZE) {
                             width *= MAX_SIZE / height;
                             height = MAX_SIZE;
                         }
                     }
                     
                     canvas.width = width;
                     canvas.height = height;
                     ctx.drawImage(img, 0, 0, width, height);
                     
                     // 压缩为 JPEG，质量 0.7
                     const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                     
                     const previewEl = document.getElementById('persona-avatar-preview');
                     previewEl.src = compressedDataUrl;
                     previewEl.style.display = 'block';
                     document.getElementById('persona-placeholder').style.display = 'none';
                 };
             };
             reader.readAsDataURL(file);
        }
        
        function clearMemory() {
             if(confirm("确定要清空所有记忆吗？")) {
                 activeStoryData.memory = "";
                 const container = document.getElementById('storyLog');
                 if(container) container.innerHTML = '<div style="text-align:center; color:#666; padding:20px;">暂无探索记录</div>';
                 
                 // 清空历史存档
                 localStorage.removeItem('infinite.all_saves');
             }
        }

        // ===== 剧本管理 =====
        function loadCustomStory() {
            const raw = localStorage.getItem(STORY_STORAGE);
            if (!raw) return;
            try {
                const parsed = JSON.parse(raw);
                if (parsed && typeof parsed === 'object') {
                    if (parsed.main_story) {
                        activeStoryData = parsed.main_story;
                    } else {
                        activeStoryData = parsed;
                    }
                }
            } catch (e) {
                console.warn('自定义剧本解析失败，已忽略：', e);
            }
        }
        
        function handleStoryUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (!json.main_story && !json.start) {
                        throw new Error("格式不对，必须包含 main_story 或 start 节点");
                    }
                    localStorage.setItem(STORY_STORAGE, JSON.stringify(json));
                    loadCustomStory();
                    document.getElementById('storyUploadMsg').textContent = ` 成功加载: ${file.name}`;
                    alert("剧本上传成功！请点击副本开始游戏。");
                } catch (err) {
                    alert("剧本文件格式错误: " + err.message);
                }
            };
            reader.readAsText(file);
        }

        function resetStory() {
            activeStoryData = storyData;
            localStorage.removeItem(STORY_STORAGE);
            document.getElementById('storyUploadMsg').textContent = "";
            alert('已恢复默认剧本');
        }

        // ===== AI 生成函数 (含记忆 + 存档 + 人设联动) =====
        async function generateAiSceneText(sceneId, scene) {
            // 1. 读取配置
            const configRaw = localStorage.getItem('apiConfig');
            if (!configRaw) return ' 未配置 API';
            const config = JSON.parse(configRaw);
            if (!config.key) return ' API Key 为空';

            // URL 修正逻辑
            let baseUrl = config.url || 'https://api.openai.com/v1';
            baseUrl = baseUrl.replace(/\/+$/, '');
            if (baseUrl.endsWith('/chat/completions')) baseUrl = baseUrl.replace(/\/chat\/completions$/, '');
            if (!baseUrl.endsWith('/v1')) baseUrl += '/v1';
            const finalUrl = baseUrl + '/chat/completions';

            // 2. 【新增】获取当前选中的人设信息
            const allPersonas = loadPersonas();
            // 查找当前高亮的 ID，如果没选，就默认叫“玩家”
            const myPersona = allPersonas.find(p => p.id === currentPersonaId) || { 
                name: "玩家", 
                desc: "一个误入此地的普通人，性格未定，试图活下去。" 
            };

            // 3. 构造带记忆 + 人设的 Prompt
            const memory = activeStoryData.memory || "";
            
            // 核心修改：把人设塞进 systemInstruction
            const systemInstruction = `
你是一个无限流文字游戏的 AI 导演。

【玩家当前人设】：
- 姓名：${myPersona.name}
- 设定：${myPersona.desc}
(请在生成剧情时，让主角的行为、心理活动、对话风格符合上述人设。如果人设是高冷，就少说话；如果是腹黑，就多心理描写。)

【前情提要】：
${memory}

【指令】：
请接续剧情。
1. 剧情必须连贯，严禁与前情冲突。
2. 尽量体现主角的人设特点。
3. 输出纯 JSON 格式：{"text": "剧情内容...", "options": [{"text":"选项A", "nextScene":"null"}]}。
`.trim();

            const userPrompt = scene.prompt || `当前进展到节点 ${sceneId}。请继续发展剧情。`;

            try {
                const res = await fetch(finalUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + config.key
                    },
                    body: JSON.stringify({
                        model: config.model || 'gpt-3.5-turbo',
                        stream: false, 
                        messages: [
                            { role: 'system', content: systemInstruction },
                            { role: 'user', content: userPrompt }
                        ],
                        temperature: 0.85
                    })
                });

                if (!res.ok) {
                    const err = await res.text();
                    return `❌ API 报错 (${res.status}): ${err}`;
                }

                const data = await res.json();
                const content = data.choices?.[0]?.message?.content || data.data?.content;
                
                if (!content) return ' API 返回结构异常:\n' + JSON.stringify(data, null, 2);

                let parsed;
                try {
                    const clean = content.replace(/```json/g, '').replace(/```/g, '').trim();
                    parsed = JSON.parse(clean);
                } catch {
                    parsed = { text: content, options: [{text:"继续", nextScene:"next"}] };
                }

                if (parsed.text) {
                    let newMem = memory + "\n" + parsed.text;
                    if (newMem.length > 2000) newMem = "..." + newMem.slice(-2000);
                    activeStoryData.memory = newMem;
                    if (typeof saveProgress === 'function') saveProgress();
                }

                return parsed;

            } catch (e) {
                return `❌ 网络错误: ${e.message}`;
            }
        }

        // ==========================================
        //  新逻辑：人设联动与弹窗检查
        // ==========================================

        // 打开选择弹窗
        let pendingGameMode = null; // 暂存用户想玩什么模式

        function openPersonaModal(mode = null) {
            pendingGameMode = mode;
            const modal = document.getElementById('personaModal');
            const listContainer = document.getElementById('modalPersonaList');
            const emptyState = document.getElementById('modalEmptyState');
            
            modal.style.display = 'flex';
            listContainer.innerHTML = '';
            
            const list = loadPersonas();
            
            if (list.length === 0) {
                listContainer.style.display = 'none';
                emptyState.style.display = 'block';
            } else {
                listContainer.style.display = 'grid';
                emptyState.style.display = 'none';
                
                list.forEach(p => {
                    const el = document.createElement('div');
                    el.className = `persona-select-item ${currentPersonaId === p.id ? 'active' : ''}`;
                    el.onclick = () => selectPersonaAndStart(p);
                    
                    const avatarHtml = p.avatar 
                        ? `<img src="${p.avatar}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">` 
                        : `<div style="width:40px;height:40px;background:#333;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;">👤</div>`;
                        
                    el.innerHTML = `
                        ${avatarHtml}
                        <div style="flex:1;">
                            <div style="font-weight:bold; font-size:14px; color:var(--text-main);">${p.name}</div>
                            <div style="font-size:12px; color:var(--text-muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:200px;">${p.desc.substring(0,20)}...</div>
                        </div>
                        ${currentPersonaId === p.id ? '<span style="color:var(--primary);">✅</span>' : ''}
                    `;
                    listContainer.appendChild(el);
                });
            }
        }

        function closePersonaModal() {
            document.getElementById('personaModal').style.display = 'none';
            pendingGameMode = null;
        }

        function goToPersonaCreate() {
            closePersonaModal();
            switchView('persona'); // 跳转到设定页
            resetPersonaForm();    // 自动切到新建模式
        }

        // 选中人设后的逻辑
        function selectPersonaAndStart(p) {
            currentPersonaId = p.id;
            
            // 更新界面上的小标签
            const label = document.getElementById('currentPersonaLabel');
            if(label) label.textContent = p.name;
            
            showToastMsg(` 已切换身份：${p.name}`);
            closePersonaModal();
            
            // 如果之前是因为点击了“开始游戏”才弹窗的，现在自动继续
            if (pendingGameMode) {
                startGame(pendingGameMode);
            }
        }
        
        // 辅助：更新游戏内名字显示
        function updateGameDisplayName() {
            if (!currentPersonaId) return;
            const list = loadPersonas();
            const p = list.find(item => item.id === currentPersonaId);
            if (p) {
                // 这里假设游戏界面某个地方显示名字，或者仅仅是Toast提示
                // document.getElementById('gamePlayerName').textContent = p.name; 
            }
        }

        // 通用辅助函数
        function triggerAvatarUpload() { document.getElementById('persona-avatar-input').click(); }
        
        function showToastMsg(msg) {
            const toast = document.getElementById('toast');
            if (!toast) return;
            toast.textContent = msg;
            toast.style.display = 'block';
            toast.style.animation = 'none';
            toast.offsetHeight; 
            toast.style.animation = 'popIn 0.3s';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 2000);
        }
        
        // 启动
        window.onload = init;
    </script>
</body>
</html>
