<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Utopia noteÂ·ä¹Œæ‰˜é‚¦æ‰‹è®°</title>
    <style>
        :root {
            /* === ä½ çš„åŸå§‹é…è‰²ç³»ç»Ÿ (ä¿æŒä¸å˜) === */
            --primary: #d946ef;
            --secondary: #8b5cf6;
            --accent: #06b6d4;
            --bg-deep: #0f0720;
            --gradient-holo: linear-gradient(135deg, rgba(217,70,239,0.8), rgba(139,92,246,0.8), rgba(6,182,212,0.8));
            --gradient-glass: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            --gradient-border: linear-gradient(90deg, #d946ef, #8b5cf6, #06b6d4);
            --glass-surface: rgba(20, 10, 35, 0.4);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.7);
            --shadow-glow: 0 0 20px rgba(139, 92, 246, 0.3);
            --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.3);
            --font-main: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', sans-serif;
        }

        /* === æ–°å¢ä¸»é¢˜ï¼šçº¸é—´é»›è“ (Reader) === */
        [data-theme="reader"] {
            --primary: #546e7a;       /* é»›è“ */
            --secondary: #78909c;     /* ç°è“ */
            --accent: #b0bec5;        /* æµ…ç° */
            --bg-deep: #fdfbf7;       /* çº¸å¼ ç±³ç™½ */
            
            /* çº¸å¼ çº¹ç†èƒŒæ™¯ */
            --gradient-holo: linear-gradient(135deg, #546e7a, #78909c);
            --gradient-glass: rgba(255, 255, 255, 0.8);
            --gradient-border: #cfd8dc;
            
            --glass-surface: rgba(255, 255, 255, 0.6); /* ç£¨ç ‚çº¸æ„Ÿ */
            --glass-border: rgba(0, 0, 0, 0.05);
            --text-main: #263238;     /* æ·±å¢¨è‰² */
            --text-muted: #607d8b;
            --shadow-glow: none;
            --shadow-card: 0 4px 6px rgba(0,0,0,0.05);
        }

        /* åŸæœ‰ä¸»é¢˜å˜ä½“ (ä¿ç•™) */
        [data-theme="black"] { --primary: #888; --secondary: #666; --accent: #999; --bg-deep: #000000; }
        [data-theme="white"] { --primary: #5b7aef; --secondary: #4461d9; --accent: #2dd4bf; --bg-deep: #f5f7fa; --glass-surface: rgba(255, 255, 255, 0.6); --text-main: #1a1a1a; --text-muted: rgba(0, 0, 0, 0.6); }
        [data-theme="green"] { --primary: #10b981; --secondary: #059669; --accent: #34d399; --bg-deep: #020a06; }
        [data-theme="blue"] { --primary: #3b82f6; --secondary: #2563eb; --accent: #60a5fa; --bg-deep: #020510; }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-deep);
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(217, 70, 239, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(6, 182, 212, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(139, 92, 246, 0.1) 0%, transparent 60%);
            background-attachment: fixed;
            transition: background 0.5s, color 0.5s;
        }

        [data-theme="reader"] body {
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
        }

        .icon {
            width: 20px; height: 20px;
            fill: none; stroke: currentColor; stroke-width: 2;
            stroke-linecap: round; stroke-linejoin: round;
            display: inline-block; vertical-align: middle;
        }

        .aurora-bg {
            position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
            background: conic-gradient(from 0deg at 50% 50%, rgba(139, 92, 246, 0.1), rgba(217, 70, 239, 0.1), rgba(6, 182, 212, 0.1), rgba(139, 92, 246, 0.1));
            filter: blur(80px); animation: rotate 20s linear infinite; z-index: -1; pointer-events: none;
        }
        [data-theme="reader"] .aurora-bg { display: none; }

        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .glass-panel {
            background: var(--glass-surface);
            backdrop-filter: blur(24px) saturate(120%);
            -webkit-backdrop-filter: blur(24px) saturate(120%);
            border: 1px solid var(--glass-border);
            border-top: 1px solid rgba(255,255,255,0.2);
            box-shadow: var(--shadow-card);
        }
        [data-theme="reader"] .glass-panel { border-top: 1px solid var(--glass-border); backdrop-filter: none; }

        /* ç™»å½•é¡µ */
        .login-page { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; position: relative; z-index: 10; }
        .login-card { width: 100%; max-width: 400px; padding: 40px 30px; border-radius: 24px; text-align: center; position: relative; overflow: hidden; }
        .login-card::after {
            content: ''; position: absolute; inset: 0; border-radius: 24px; padding: 1px;
            background: var(--gradient-border); -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; pointer-events: none;
        }
        .login-title { font-size: 36px; font-weight: 800; margin-bottom: 8px; background: var(--gradient-border); -webkit-background-clip: text; background-clip: text; color: transparent; letter-spacing: -1px; }
        .login-subtitle { color: var(--text-muted); font-size: 14px; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 40px; }
        
        .input-wrapper { position: relative; margin-bottom: 24px; }
        .input-modern {
            width: 100%; padding: 16px 20px;
            background: rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px; color: var(--text-main); font-size: 16px; outline: none; transition: all 0.3s;
        }
        .input-modern:focus { background: rgba(0,0,0,0.2); border-color: var(--secondary); box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.2); }

        .btn-glow {
            width: 100%; padding: 16px; border: none; border-radius: 16px;
            background: var(--gradient-holo); color: white; font-size: 16px; font-weight: 600;
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-glow:active { transform: scale(0.98); }
        .btn-glow:hover { box-shadow: 0 0 30px rgba(217, 70, 239, 0.4); }

        /* ä¸»ç•Œé¢ */
        .main-hub { display: none; padding: 20px 20px 100px 20px; max-width: 1200px; margin: 0 auto; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        .user-pill { display: flex; align-items: center; gap: 12px; padding: 8px 16px 8px 8px; border-radius: 100px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); }
        .avatar-small { width: 32px; height: 32px; border-radius: 50%; background: var(--gradient-holo); display: flex; align-items: center; justify-content: center; overflow: hidden; color: #fff; }
        .avatar-small img { width: 100%; height: 100%; object-fit: cover; }

        .resource-pill { display: flex; gap: 16px; }
        .res-item { display: flex; align-items: center; gap: 6px; font-size: 14px; font-weight: 600; padding: 6px 12px; border-radius: 12px; }
        .res-icon { color: var(--accent); }

        /* åº•éƒ¨å¯¼èˆª Dock */
        .dock-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 8px; padding: 10px; border-radius: 24px; z-index: 100;
        }
        .dock-item {
            position: relative; width: 50px; height: 50px; border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-muted); cursor: pointer; transition: all 0.3s;
        }
        .dock-item:hover, .dock-item.active { color: var(--text-main); background: rgba(255,255,255,0.15); transform: translateY(-5px); }
        .dock-item.active { color: var(--primary); }
        
        /* è§†å›¾å®¹å™¨ */
        .view-section { display: none; animation: fadeIn 0.4s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* å‰¯æœ¬å¡ç‰‡ */
        .section-header { font-size: 24px; font-weight: 700; margin-bottom: 20px; background: linear-gradient(to right, var(--text-main), var(--text-muted)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: flex; align-items: center; gap: 8px;}
        .section-header svg { color: var(--text-main); -webkit-text-fill-color: initial; }

        .grid-layout { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px; }
        .card-instance { border-radius: 24px; overflow: hidden; transition: transform 0.3s, box-shadow 0.3s; cursor: pointer; position: relative; }
        .card-instance:hover { transform: translateY(-8px); box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
        .card-instance.locked { opacity: 0.6; cursor: not-allowed; }
        .card-instance.locked:hover { transform: none; }
        
        .card-cover { height: 200px; width: 100%; position: relative; background: linear-gradient(135deg, var(--primary), var(--secondary)); }
        .card-cover img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
        .card-instance:not(.locked):hover .card-cover img { transform: scale(1.1); }
        
        .card-badge { position: absolute; top: 12px; left: 12px; padding: 4px 12px; border-radius: 100px; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); font-size: 12px; font-weight: 600; border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; gap: 4px;}
        .card-body { padding: 20px; }
        .card-title { font-size: 18px; font-weight: 700; margin-bottom: 6px; }
        .card-desc { font-size: 13px; color: var(--text-muted); line-height: 1.5; }
        
        .locked-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; }
        .lock-icon { font-size: 32px; opacity: 0.8; color: #fff; }

        /* è¯¦æƒ…é¡µ */
        .detail-layout { display: flex; gap: 24px; border-radius: 24px; padding: 24px; margin-bottom: 24px; }
        .detail-cover { flex: 0 0 40%; border-radius: 20px; overflow: hidden; background: #111; }
        .detail-cover img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .detail-info { flex: 1; display: flex; flex-direction: column; justify-content: space-between; gap: 16px; }
        .detail-title { font-size: 32px; font-weight: 800; margin-bottom: 8px; }
        .detail-meta { font-size: 14px; color: var(--text-muted); line-height: 1.7; }
        .tag-row { display: flex; gap: 10px; margin-top: 8px; }
        .tag { padding: 4px 10px; background: rgba(255,255,255,0.08); border-radius: 999px; font-size: 12px; }

        /* è§’è‰²å¤´åƒ */
        .char-scroll { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 20px; scrollbar-width: none; }
        .char-item { flex: 0 0 auto; text-align: center; width: 80px; }
        .char-avatar { width: 80px; height: 80px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2); padding: 2px; margin-bottom: 8px; position: relative; background: linear-gradient(135deg, var(--primary), var(--secondary)); overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .char-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .char-name { font-size: 12px; color: var(--text-muted); }

        /* èº«ä»½æ  */
        .persona-strip-container { display: flex; gap: 16px; overflow-x: auto; padding: 10px 4px; scrollbar-width: none; }
        .persona-strip-container::-webkit-scrollbar { display: none; }
        .story-ring { flex: 0 0 auto; display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer; width: 64px; }
        .story-avatar-wrap { width: 56px; height: 56px; border-radius: 50%; padding: 2px; background: linear-gradient(45deg, var(--primary), var(--secondary)); position: relative; }
        .story-avatar-wrap.new-btn { background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; }
        .story-avatar-inner { width: 100%; height: 100%; border-radius: 50%; border: 2px solid var(--bg-deep); background: #222; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .story-avatar-inner img { width: 100%; height: 100%; object-fit: cover; }
        .story-name { font-size: 11px; color: var(--text-main); max-width: 60px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* ç³»ç»Ÿè®¾ç½® */
        .settings-container { max-width: 600px; margin: 0 auto; }
        .setting-group { margin-bottom: 24px; padding: 24px; border-radius: 20px; }
        .input-label { display: block; margin-bottom: 8px; font-size: 13px; color: var(--text-muted); font-weight: 600; }
        .theme-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; margin-top: 12px; }
        .theme-btn { padding: 12px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.05); color: var(--text-main); cursor: pointer; transition: all 0.3s; font-size: 14px; font-weight: 600; }
        .theme-btn:hover { border-color: var(--primary); transform: translateY(-2px); }
        .theme-btn.active { background: var(--gradient-holo); border-color: transparent; color: white; }

        /* æ¸¸æˆç•Œé¢ */
        .game-container { position: fixed; inset: 0; z-index: 200; display: none; background-color: #000; overflow: hidden; }
        .game-bg { position: absolute; inset: 0; background-size: cover; background-position: center; filter: brightness(0.65); }
        .game-content { position: relative; z-index: 1; display: flex; flex-direction: column; justify-content: flex-end; height: 100%; padding: 20px 16px 28px; }
        .game-text-box { max-width: 900px; margin: 0 auto 16px; background: rgba(0,0,0,0.68); border-radius: 16px; padding: 16px 18px; color: #fff; min-height: 90px; font-size: 15px; line-height: 1.7; cursor: pointer; }
        .game-options { max-width: 900px; margin: 0 auto; display: flex; flex-wrap: wrap; gap: 10px; }
        .game-option-btn { padding: 10px 16px; border-radius: 999px; border: none; background: rgba(0,0,0,0.7); color: #fff; font-size: 14px; cursor: pointer; transition: background 0.2s, transform 0.1s; }
        .game-option-btn:hover { background: rgba(255,255,255,0.2); }
        .game-exit-btn { position: absolute; top: 14px; right: 16px; z-index: 2; padding: 8px 14px; border-radius: 999px; border: none; background: rgba(0,0,0,0.7); color: #fff; font-size: 13px; cursor: pointer; }

        /* å‰§æœ¬ä¸Šä¼  */
        .story-upload-area { margin-top: 30px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; }
        .file-btn { display: inline-block; padding: 10px 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; cursor: pointer; color: var(--text-muted); font-size: 13px; }

        /* === ğŸ“± ç§»åŠ¨ç«¯æ·±åº¦é€‚é… === */
        @media (max-width: 768px) {
            .grid-layout { grid-template-columns: 1fr 1fr; gap: 12px; }
            .card-cover { height: 140px; background: #222; }
            .card-title { font-size: 15px; margin-bottom: 4px; }
            .card-desc { font-size: 11px; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
            .card-badge { top: 8px; left: 8px; padding: 2px 8px; font-size: 10px; }
            
            .detail-layout { flex-direction: row; flex-wrap: wrap; padding: 16px; gap: 16px; align-items: flex-start; background: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0) 100%); }
            .detail-cover { flex: 0 0 100px; height: 140px; width: 100px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); margin-bottom: 0; }
            .detail-info { flex: 1; min-width: 0; gap: 6px; display: flex; flex-direction: column; }
            .detail-title { font-size: 18px; line-height: 1.2; margin-bottom: 2px; }
            .detail-meta { font-size: 11px; opacity: 0.8; }
            .tag-row { margin-top: 4px; gap: 6px; }
            .tag { padding: 2px 6px; font-size: 10px; background: rgba(255,255,255,0.1); }
            .detail-desc { font-size: 12px; line-height: 1.4; color: var(--text-muted); margin-top: 6px; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; }
            
            .detail-info > div:last-child { margin-top: 12px; width: calc(100% + 116px); margin-left: -116px; display: flex; gap: 10px; }
            .detail-info .btn-glow { padding: 0; font-size: 13px; border-radius: 10px; height: 40px; }
            .detail-info + button.btn-glow { margin-top: 0; font-size: 12px; padding: 0; height: 36px; opacity: 0.8; }
            
            .dock-nav { width: 94%; padding: 10px 16px; justify-content: space-between; bottom: 16px; }
            .game-content { padding: 16px; }
            .game-text-box { font-size: 15px; padding: 16px; min-height: 100px; }
            .game-exit-btn { top: 12px; right: 12px; padding: 6px 12px; font-size: 12px; }
        }
        
        /* å¼¹çª—æ ·å¼ */
        .modal-overlay { position: fixed; inset: 0; z-index: 999; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; animation: fadeIn 0.2s; }
        .modal-card { width: 90%; max-width: 400px; padding: 24px; border-radius: 24px; background: var(--bg-deep); border: 1px solid var(--primary); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-btn { background: none; border: none; color: var(--text-main); font-size: 24px; cursor: pointer; }
        .modal-list { display: grid; gap: 12px; max-height: 300px; overflow-y: auto; }
        .persona-select-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; background: rgba(255,255,255,0.05); cursor: pointer; transition: all 0.2s; border: 1px solid transparent; }
        .persona-select-item:hover, .persona-select-item.active { background: rgba(255,255,255,0.1); border-color: var(--primary); }

        /* è®°å¿†å›æ”¾æ¡†æ ·å¼ */
        .log-container { background: rgba(0,0,0,0.1); border-radius: 12px; padding: 20px; height: 300px; overflow-y: auto; font-size: 14px; line-height: 1.8; white-space: pre-wrap; color: var(--text-muted); margin-top: 10px; }
        
        /* è®°å¿†å›å»ŠæŠ˜å æ ·å¼ */
        .gallery-item { background:var(--glass-surface); border-radius:12px; margin-bottom:12px; border-left:4px solid var(--primary); box-shadow:var(--shadow-card); overflow:hidden; transition: all 0.3s ease; }
        .gallery-header { padding: 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: rgba(255,255,255,0.02); }
        .gallery-header:hover { background: rgba(255,255,255,0.05); }
        .gallery-toggle-icon { transition: transform 0.3s; opacity: 0.6; font-size: 12px; }
        .gallery-content { padding: 0 16px 16px 16px; display: none; animation: fadeIn 0.3s; }
        .gallery-item.open .gallery-content { display: block; }
        .gallery-item.open .gallery-toggle-icon { transform: rotate(180deg); }

        /* Toast æç¤ºæ¡†æ ·å¼ */
        #toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.85); color: #fff; padding: 12px 24px; border-radius: 50px; display: none; z-index: 300; backdrop-filter: blur(10px); border: 1px solid var(--primary); font-weight: bold; animation: popIn 0.3s; }
        @keyframes popIn { from { transform: translate(-50%, -40%); opacity: 0; } to { transform: translate(-50%, -50%); opacity: 1; }}
    </style>
</head>
<body data-theme="purple">
    <div class="aurora-bg"></div>
    <div id="toast"> æ“ä½œæˆåŠŸ</div>
    
    <div class="login-page" id="loginPage">
        <div class="login-card glass-panel">
            <h1 class="login-title">INFINITE LOVE</h1>
            <p class="login-subtitle">Utopia note Â· ä¹Œæ‰˜é‚¦æ‰‹è®°</p>
            
            <div class="input-wrapper">
                <input type="text" class="input-modern" id="username" placeholder="è¯·è¾“å…¥ä½ çš„ä»£å·..." autocomplete="off">
            </div>
            
            <button class="btn-glow" onclick="enterHub()">
                <span style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                    è¿æ¥ç¥ç»å…ƒ
                    <svg class="icon" viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                </span>
            </button>
        </div>
    </div>

    <div class="main-hub" id="mainHub">
        <div class="top-bar">
            <div class="user-pill glass-panel">
                <div class="avatar-small">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                </div>
                <span style="font-weight: 600; font-size: 14px;" id="displayName">æ—…è¡Œè€…</span>
            </div>

            <div class="resource-pill">
                <div class="res-item glass-panel" style="padding: 6px 12px; border-radius: 12px;">
                    <svg class="icon res-icon" viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                    <span>80</span>
                </div>
                <div class="res-item glass-panel" style="padding: 6px 12px; border-radius: 12px;">
                    <svg class="icon res-icon" style="color: #d946ef;" viewBox="0 0 24 24"><path d="M6 3h12l4 6-10 10L2 9h4z"/></svg>
                    <span>1250</span>
                </div>
            </div>
        </div>

        <div class="view-section active" id="view-hub">
            <h2 class="section-header">æ¢ç´¢ä¸–ç•Œ</h2>
            <div class="grid-layout" id="hub-dungeon-list">
                </div>
        </div>

        <div class="view-section" id="view-detail">
            <button class="glass-panel" onclick="switchView('hub')" style="margin-bottom: 20px; padding: 10px 20px; border-radius: 12px; border:none; color:var(--text-main); cursor:pointer; display:flex; align-items:center; gap:8px;">
                <svg class="icon" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                è¿”å›
            </button>

            <div class="detail-layout glass-panel" id="detail-card-container">
                </div>

            <div class="glass-panel" style="padding: 24px; border-radius: 24px; margin-bottom: 30px;">
                <h3 style="margin-bottom: 16px; font-weight: 700;">ä¸»è¦è§’è‰²</h3>
                <div class="char-scroll" id="detail-char-list">
                    </div>
            </div>

            <div class="glass-panel" style="padding: 24px; border-radius: 24px;">
                <h3 style="margin-bottom: 16px; font-weight: 700;"> ç¤¾åŒºè¯„ä»·</h3>
                <div style="background: rgba(0,0,0,0.1); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 3px solid var(--primary);">
                    <div style="color: var(--primary); font-weight: 600; margin-bottom: 8px;">åŒ¿åç©å®¶</div>
                    <div style="color: var(--text-muted); line-height: 1.6; font-size: 14px;">
                        "å‰§æƒ…åè½¬å¤ªç²¾å½©äº†ï¼"
                    </div>
                </div>
            </div>
        </div>

        <div class="view-section" id="view-gallery">
            <h2 class="section-header">è®°å¿†å›å»Š</h2>
            <div class="settings-container glass-panel setting-group">
                <div style="padding:10px;">
                    <p style="color:var(--text-muted); font-size:12px; margin-bottom:10px;">æŸ¥çœ‹å’Œç»§ç»­ä½ çš„å†’é™©å­˜æ¡£</p>
                    <div id="storyLog" class="log-container">æš‚æ— è®°å¿†</div>
                    <button class="btn-glow" onclick="clearMemory()" style="margin-top:15px; background:rgba(239,68,68,0.5);">
                        <svg class="icon" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg> 
                        æ¸…ç©ºæ‰€æœ‰å­˜æ¡£
                    </button>
                </div>
            </div>
        </div>

        <div class="view-section" id="view-shop">
            <h2 class="section-header">é“å…·å•†åº—</h2>
            <div class="settings-container glass-panel setting-group">
                <p style="color: var(--text-muted); line-height: 1.8;">
                    é­…åŠ›å£çº¢ã€æµ‹è°ä»ªã€é™å®šé—¨ç¥¨ç­‰é“å…·å³å°†ä¸Šçº¿...
                </p>
            </div>
        </div>

<div class="view-section" id="view-persona">
            <h2 class="section-header">æˆ‘çš„è®¾å®š</h2>
            <div class="persona-container">
                <div class="glass-panel" style="border-radius: 20px; padding: 12px 16px; margin-bottom: 20px;">
                    <div class="persona-strip-container" id="persona-strip"></div>
                </div>

                <div class="glass-panel persona-form" style="margin-top: 16px; padding: 20px;">
                    <div class="input-wrapper">
                        <label class="input-label">å§“å</label>
                        <input id="persona-name" class="input-modern" placeholder="è§’è‰²å">
                    </div>
                    <div class="input-wrapper">
                        <label class="input-label">è®¾å®š</label>
                        <textarea id="persona-desc" class="input-modern" style="min-height: 100px;" placeholder="äººç‰©å°ä¼ ..."></textarea>
                    </div>
                    <div class="input-wrapper">
                        <label class="input-label">å¤´åƒ</label>
                        <div style="display:flex; align-items:center; gap:16px;">
                            <div class="persona-avatar-slot" id="persona-avatar-slot" onclick="triggerAvatarUpload()" style="width: 60px; height: 60px; background: rgba(255,255,255,0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden;">
                                <img id="persona-avatar-preview" style="display:none; width:100%; height:100%; object-fit:cover;">
                                <span id="persona-placeholder" style="font-size: 10px;">ç‚¹å‡»ä¸Šä¼ </span>
                            </div>
                            <span style="font-size:12px; color:var(--text-muted);">ä»…æœ¬åœ°ä¿å­˜</span>
                        </div>
                        <input type="file" id="persona-avatar-input" accept="image/*" style="display:none;" onchange="onAvatarFileChange(event)">
                    </div>
                    <div class="persona-actions" style="margin-top: 20px;">
                        <button class="btn-glow" style="flex:1;" onclick="savePersona()">ä¿å­˜è®¾å®š</button>
                    </div>
                </div>
            </div>
        </div> 
        
<div class="view-section" id="view-settings">
            <h2 class="section-header">ç³»ç»Ÿè®¾ç½®</h2>
            
            <div class="settings-container glass-panel setting-group">
                <h3 style="margin-bottom: 20px; font-size: 18px;">API è¿æ¥é…ç½®</h3>
                <div class="input-wrapper">
                    <label class="input-label">é…ç½®åç§°</label>
                    <input type="text" class="input-modern" id="apiName" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„ OpenAI é…ç½®">
                </div>
                <div class="input-wrapper">
                    <label class="input-label">API URL ä»£ç†åœ°å€</label>
                    <input type="text" class="input-modern" id="apiUrl" placeholder="ä¾‹å¦‚ï¼šhttps://api.openai.com/v1">
                </div>
                <div class="input-wrapper">
                    <label class="input-label">API å¯†é’¥ (Key)</label>
                    <input type="password" class="input-modern" id="settingsApiKey" placeholder="sk-...">
                </div>
                <div class="input-wrapper">
                    <label class="input-label">æ¨¡å‹é€‰æ‹©</label>
                    <select class="input-modern" id="apiModel" style="cursor: pointer;">
                        <option value="">-- è¯·å…ˆæµ‹è¯•è¿æ¥è·å–æ¨¡å‹åˆ—è¡¨ --</option>
                    </select>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn-glow" style="flex: 1;" onclick="testApiConnection()">æµ‹è¯•è¿æ¥</button>
                    <button class="btn-glow" style="flex: 1;" onclick="saveApiConfig()">ä¿å­˜é…ç½®</button>
                </div>
                <div id="apiTestResult" style="margin-top: 12px; padding: 12px; border-radius: 8px; font-size: 13px; display: none;"></div>
            </div>

            <div class="settings-container glass-panel setting-group" style="margin-top: 24px;">
                <h3 style="margin-bottom: 20px; font-size: 18px;">å‰§æœ¬ç®¡ç†</h3>
                <div style="display:flex; gap:10px; align-items:center;">
                    <label class="file-btn">
                         ä¸Šä¼ å‰§æœ¬æ–‡ä»¶
                        <input type="file" id="storyFileUpload" accept=".json" style="display:none;" onchange="handleStoryUpload(event)">
                    </label>
                    <button class="btn-glow" style="background: rgba(239, 68, 68, 0.5); width: auto;" onclick="resetStory()">æ¢å¤é»˜è®¤</button>
                </div>
                <div id="storyUploadMsg" style="margin-top:8px; font-size:12px; color:#10b981;"></div>
            </div>

            <div class="settings-container glass-panel setting-group" style="margin-top: 24px;">
                <h3 style="margin-bottom: 20px; font-size: 18px;">ä¸»é¢˜é£æ ¼</h3>
                <div class="theme-grid">
                    <button class="theme-btn active" data-theme="purple" onclick="changeTheme('purple')">éœ“è™¹ç´«</button>
                    <button class="theme-btn" data-theme="reader" onclick="changeTheme('reader')" style="background:#fdfbf7; color:#263238; border:1px solid #b0bec5;">çº¸é—´é»›è“</button>
                    <button class="theme-btn" data-theme="black" onclick="changeTheme('black')">é»‘è‰²</button>
                    <button class="theme-btn" data-theme="white" onclick="changeTheme('white')">ç™½è‰²</button>
                    <button class="theme-btn" data-theme="green" onclick="changeTheme('green')">ç»¿è‰²</button>
                    <button class="theme-btn" data-theme="blue" onclick="changeTheme('blue')">è“è‰²</button>
                </div>
            </div>

            <div class="settings-container glass-panel setting-group" style="margin-top: 24px;">
                <h3 style="margin-bottom: 20px; font-size: 18px;">âœ¨ å­—ä½“ç¾åŒ–</h3>
                <div style="margin-bottom:10px; font-size:12px; color:var(--text-muted);">
                    è¾“å…¥ .woff2 / .ttf æ–‡ä»¶é“¾æ¥æˆ– Google Fonts CSS é“¾æ¥
                </div>
                <div style="display:flex; gap:10px;">
                    <input id="customFontUrl" class="input-modern" placeholder="https://example.com/font.woff2">
                    <button class="btn-glow" style="width:auto; padding:0 20px;" onclick="applyCustomFont()">åº”ç”¨</button>
                </div>
            </div>

            <div class="settings-container glass-panel setting-group" style="margin-top: 24px;">
                <h3 style="margin-bottom: 20px; font-size: 18px;">ğŸ¨ è‡ªå®šä¹‰æ ·å¼ (CSS)</h3>
                <div style="margin-bottom:10px; font-size:12px; color:var(--text-muted);">
                    åœ¨æ­¤è¾“å…¥ CSS ä»£ç å¯è¦†ç›–ç³»ç»Ÿé»˜è®¤æ ·å¼ã€‚ä¾‹å¦‚ï¼š<br>
                    <code style="background:rgba(255,255,255,0.1); padding:2px 4px; border-radius:4px;">.btn-glow { background: red; }</code>
                </div>
                <textarea id="customCssInput" class="input-modern" style="min-height: 150px; font-family: 'Menlo', 'Monaco', 'Courier New', monospace; font-size: 13px; line-height: 1.5;" placeholder="/* åœ¨æ­¤å¤„è¾“å…¥ CSS ä»£ç  */"></textarea>
                <div style="display:flex; gap:10px; margin-top:16px;">
                    <button class="btn-glow" style="flex:1;" onclick="applyCustomCss()">åº”ç”¨å¹¶ä¿å­˜</button>
                    <button class="btn-glow" style="background: rgba(239, 68, 68, 0.5); width: auto;" onclick="clearCustomCss()">æ¸…ç©º</button>
                </div>
            </div>
         </div>
        
        <div class="dock-nav glass-panel">
            <div class="dock-item active" onclick="switchView('hub')" title="å‰¯æœ¬ä¸­å¿ƒ">
                <svg class="icon dock-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
            </div>
            <div class="dock-item" onclick="switchView('gallery')" title="è®°å¿†å›å»Š">
                <svg class="icon dock-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
            </div>
            <div class="dock-item" onclick="switchView('shop')" title="é“å…·å•†åº—">
                <svg class="icon dock-icon" viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
            </div>
            <div class="dock-item" onclick="switchView('persona')" title="æˆ‘çš„è®¾å®š">
                <svg class="icon dock-icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            </div>
            <div class="dock-item" onclick="switchView('settings')" title="ç³»ç»Ÿè®¾ç½®">
                <svg class="icon dock-icon" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
            </div>
        </div>
    </div> 
            
        <div id="gameContainer" class="game-container">
        <div id="gameBg" class="game-bg"></div>
        <button class="game-exit-btn" onclick="openSaveSlotModal()" style="right: 80px; background: rgba(16, 185, 129, 0.6);"> å­˜æ¡£</button>       
        <button class="game-exit-btn" onclick="exitGame()">é€€å‡º</button>
        <div class="game-content">
            <div id="gameTextBox" class="game-text-box">
                <span id="gameText"></span>
            </div>
            <div id="gameOptions" class="game-options"></div>
        </div>
    </div>

    <div id="personaModal" class="modal-overlay" style="display:none;">
        <div class="modal-card glass-panel">
            <div class="modal-header">
                <h3> é€‰æ‹©ä½ çš„èº«ä»½</h3>
                <button class="close-btn" onclick="closePersonaModal()">Ã—</button>
            </div>
            <div id="modalPersonaList" class="modal-list">
                </div>
            <div id="modalEmptyState" style="display:none; text-align:center; padding:20px;">
                <p style="color:var(--text-muted); margin-bottom:15px;">æš‚æ— å¯ç”¨äººè®¾</p>
                <button class="btn-glow" onclick="goToPersonaCreate()"> å»åˆ›å»ºæ–°äººè®¾</button>
            </div>
        </div>
    </div>

    <script>
        const USERNAME_STORAGE = 'infinite.username';
        const PERSONA_STORAGE = 'infinite.personas';
        const STORY_STORAGE = 'infinite.customStory';
        const FONT_STORAGE = 'infinite.customFont';

        let currentPersonaId = null;
        let currentSceneId = null; // å…¨å±€è®°å½•å½“å‰åœºæ™¯ ID

        // æ‰“å­—æœºçŠ¶æ€
        let typingTimer = null;
        let typingIndex = 0;
        let typingText = '';
        let isTyping = false;

        // --- é»˜è®¤å‰¯æœ¬æ•°æ® (ç»Ÿä¸€å…¥å£) ---
        const defaultDungeon = {
            meta: {
                title: "ç´«ç¦åŸè¿·æ¢¦",
                desc: "æƒåŠ›ä¸çˆ±æ¬²äº¤ç»‡çš„æ·±å®«ï¼Œç©¿è¶Šåˆ°æ˜æœæ°¸ä¹å¹´é—´ï¼Œä½ æˆä¸ºäº†ä¸€åå…¥å®«çš„ç§€å¥³ã€‚åœ¨è¿™ä¸ªé‡‘ç¢§è¾‰ç…Œå´æš—æµæ¶ŒåŠ¨çš„ç´«ç¦åŸä¸­ï¼Œæ¯ä¸€æ­¥éƒ½å¯èƒ½æ˜¯ç”Ÿæ­»è€ƒéªŒã€‚",
                cover: "https://images.unsplash.com/photo-1599707367072-cd6ad6cb3d2e?auto=format&fit=crop&w=1200&q=80",
                tags: ["å¤ä»£å®«å»·", "æƒè°‹", "æ‹çˆ±"]
            },
            characters: [
                { name: "å¤œå¹½çš‡å­", avatar: "" }, 
                { name: "ä¾å«äº‘å¢¨", avatar: "" },
                { name: "ç¥ç§˜æœ¯å£«", avatar: "" }
            ],
            scripts: {
                start: {
                    type: 'fixed',
                    bg: 'https://images.unsplash.com/photo-1599707367072-cd6ad6cb3d2e?auto=format&fit=crop&w=1200&q=80',
                    text: `å¤œé£ä»å®«å¢™ä¹‹ä¸Šå¹è¿‡ï¼Œæªè§’çš„é‡‘é“ƒè¢«å¹å¾—è½»è½»ä½œå“ã€‚ä½ éšåŒæ–°å…¥å®«çš„ç§€å¥³é˜Ÿä¼ç¼“ç¼“å‰è¡Œï¼Œè„šä¸‹æ˜¯è¢«å²æœˆç£¨å¾—å‘äº®çš„é’çŸ³æ¿...`,
                    options: [
                        { text: 'é¡ºä»é¢†è·¯å®«å¥³ï¼Œå®‰é™åœ°èµ°å®Œå…¥å®«æµç¨‹', nextScene: 'followMaid' },
                        { text: 'å·å·å›å¤´ï¼Œçœ‹ä¸€çœ¼ç«™åœ¨æš—å¤„çš„ä¾å«', nextScene: 'lookGuard' }
                    ]
                },
                followMaid: {
                    type: 'fixed',
                    bg: 'https://images.unsplash.com/photo-1563298723-dcfebaa392e3?auto=format&fit=crop&w=1200&q=80',
                    text: `ä½ å‹ä¸‹å¿ƒä¸­æ‰€æœ‰çš„å¥½å¥‡ï¼Œåªæ˜¯ä½å¤´è·Ÿåœ¨é¢†è·¯å®«å¥³èº«å...`,
                    options: [
                        { text: 'å‡è£…æ²¡å¬è§ï¼Œå…ˆç¨³ä½è„šè·Ÿ', nextScene: 'safeEnd' },
                        { text: 'è®°ä¸‹è¿™äº›è¯ï¼Œæš—ä¸­æŸ¥æ¸…çœŸç›¸', nextScene: 'plotBeginAi' }
                    ]
                },
                lookGuard: {
                    type: 'fixed',
                    bg: 'https://images.unsplash.com/photo-1558985303-38eab1f8e51c?auto=format&fit=crop&w=1200&q=80',
                    text: `ä½ ä¸é¡¾å®«è§„ï¼Œè¿˜æ˜¯å›å¤´çœ‹äº†ä¸€çœ¼...`,
                    options: [
                        { text: 'è®°ä½è¿™ä½ä¾å«ï¼Œæ‚„æ‚„è·Ÿåœ¨é˜Ÿä¼ä¸­é—´', nextScene: 'plotBeginAi' },
                        { text: 'æ— è§†è­¦å‘Šï¼Œè¶äººä¸æ³¨æ„æ—¶ç»•è¿‘å®«å¢™', nextScene: 'dangerEnd' }
                    ]
                },
                plotBeginAi: {
                    type: 'ai',
                    bg: 'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1200&q=80',
                    prompt: 'ç»§ç»­è¿™ä¸ªç´«ç¦åŸå¼€å±€æ•…äº‹ï¼šä¸»è§’åœ¨å¤œè‰²ä¸­æ„è¯†åˆ°è‡ªå·±è¢«å·å…¥æƒè°‹æ–—äº‰ä¹‹ä¸­ï¼Œè¯­æ°”åæŠ’æƒ…ã€ç¬¬ä¸€äººç§°ï¼Œæ§åˆ¶åœ¨ 250 å­—ä»¥å†…ã€‚',
                    options: [{ text: 'æœ¬ç« ç»“æŸï¼Œå›åˆ°ä¸»ç¥ç©ºé—´', nextScene: null }]
                },
                safeEnd: {
                    type: 'fixed',
                    bg: 'https://images.unsplash.com/photo-1578301978018-3005759f48f9?auto=format&fit=crop&w=1200&q=80',
                    text: `ä½ é€‰æ‹©æŠŠæ‰€æœ‰ä¸å®‰å…ˆå‹åœ¨å¿ƒåº•...`,
                    options: [{ text: 'ç»“æŸä½“éªŒ', nextScene: null }]
                },
                dangerEnd: {
                    type: 'fixed',
                    bg: 'https://images.unsplash.com/photo-1526498460520-4c246339dccb?auto=format&fit=crop&w=1200&q=80',
                    text: `ä½ è¶å®«å¥³å›å¤´ç‚¹äººæ•°çš„ç©ºæ¡£ï¼Œæ‚„æ‚„å¾€å®«å¢™é˜´å½±é‡Œé€€å»...`,
                    options: [{ text: 'ç»“æŸä½“éªŒ', nextScene: null }]
                }
            }
        };

        // å…¨å±€çŠ¶æ€å˜é‡
        let currentDungeon = defaultDungeon;
        let activeStoryData = currentDungeon.scripts; // æ ¸å¿ƒä¿®å¤ï¼šç¡®ä¿å®ƒå¼•ç”¨å½“å‰å‰§æœ¬çš„è„šæœ¬

        // åˆå§‹åŒ–
        function init() {
            loadApiConfig();
            loadTheme();
            loadCustomFont(); 
            loadCustomStory(); // è¿™é‡Œä¼šè‡ªåŠ¨åŠ è½½å¹¶æ›´æ–° currentDungeon å’Œ activeStoryData

            // ç”¨æˆ·åè‡ªåŠ¨å›å¡« + è‡ªåŠ¨è¿›å…¥ä¸»ç•Œé¢
            const nameInput = document.getElementById('username');
            const savedName = localStorage.getItem(USERNAME_STORAGE);
            if (savedName) {
                nameInput.value = savedName;
                document.getElementById('displayName').textContent = savedName;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainHub').style.display = 'block';
                renderUI(); // ç¡®ä¿åŠ è½½å®Œå‰§æœ¬åæ¸²æŸ“UI
                switchView('hub');
            }

            nameInput.addEventListener('blur', () => {
                const v = nameInput.value.trim();
                if (v) localStorage.setItem(USERNAME_STORAGE, v);
            });

            initPersonas();
            renderUI(); 
        }

        // === æ ¸å¿ƒé€»è¾‘ï¼šUIåŠ¨æ€æ¸²æŸ“ ===
        function renderUI() {
            renderHub();
            renderDetail();
        }

        function renderHub() {
            const container = document.getElementById('hub-dungeon-list');
            if(!container) return;

            container.innerHTML = '';
            const meta = currentDungeon.meta || defaultDungeon.meta;
            
            const activeCard = document.createElement('div');
            activeCard.className = 'card-instance glass-panel';
            activeCard.onclick = showInstanceDetail;
            activeCard.innerHTML = `
                <div class="card-cover">
                    <img src="${meta.cover}" alt="${meta.title}">
                    <span class="card-badge">${(meta.tags && meta.tags[0]) || 'å†’é™©'}</span>
                </div>
                <div class="card-body">
                    <div class="card-title">${meta.title}</div>
                    <div class="card-desc">${meta.desc}</div>
                </div>
            `;
            container.appendChild(activeCard);

            const lockedCard = document.createElement('div');
            lockedCard.className = 'card-instance glass-panel locked';
            lockedCard.innerHTML = `
                <div class="card-cover">
                    <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#fff;">
                        <svg class="icon" style="width:48px;height:48px;" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                    </div>
                    <span class="card-badge" style="background: rgba(0,0,0,0.8);">å¾…è§£é”</span>
                </div>
                <div class="card-body">
                    <div class="card-title">???</div>
                    <div class="card-desc">æ›´å¤šä¸–ç•Œæ­£åœ¨æ„å»ºä¸­...</div>
                </div>
                <div class="locked-overlay">
                    <svg class="icon lock-icon" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                    <div class="lock-text">DLC å³å°†ä¸Šçº¿</div>
                </div>
            `;
            container.appendChild(lockedCard);
        }

        function renderDetail() {
            const container = document.getElementById('detail-card-container');
            const charContainer = document.getElementById('detail-char-list');
            if(!container || !charContainer) return;

            const meta = currentDungeon.meta || defaultDungeon.meta;
            const chars = currentDungeon.characters || [];

            let tagsHtml = '';
            if(meta.tags && meta.tags.length){
                meta.tags.forEach(t => tagsHtml += `<span class="tag">${t}</span>`);
            } else {
                tagsHtml = `<span class="tag">è‡ªå®šä¹‰</span>`;
            }

            container.innerHTML = `
                <div class="detail-cover">
                    <img src="${meta.cover}" alt="å°é¢">
                </div>
                <div class="detail-info">
                    <div>
                        <div class="detail-title" style="display:flex; align-items:center; gap:12px;">
                            ${meta.title}
                            <div onclick="openPersonaModal()" style="font-size:14px; padding:4px 10px; background:rgba(255,255,255,0.1); border-radius:20px; cursor:pointer; border:1px solid rgba(255,255,255,0.2); display:flex; align-items:center; gap:4px;">
                                <span id="currentPersonaLabel">æœªé€‰äººè®¾</span>
                                <svg class="icon" style="width:14px;height:14px;" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"/></svg>
                            </div>
                        </div>
                        <div class="detail-meta">
                            æ ‡ç­¾ï¼š<div class="tag-row">${tagsHtml}</div>
                            <div class="detail-desc">${meta.desc}</div>
                        </div>
                    </div>
                    <div>
                        <div style="display:flex; gap:10px;">
                            <button class="btn-glow" style="flex:1" onclick="startGame('start')">
                                <svg class="icon" viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 1-4 4v14a3 3 0 0 1 3-3h7z"></path></svg> 
                                å¼€å§‹å‰§æƒ…
                            </button>
                            <button class="btn-glow" style="flex:1; background: rgba(16, 185, 129, 0.2);" onclick="startGame('continue')">
                                <svg class="icon" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                                ç»§ç»­å‰§æƒ…
                            </button>
                        </div>
                        <button class="btn-glow" onclick="startGame('endless')" style="width:100%; margin-top:10px; background: rgba(255,255,255,0.1);">
                            <svg class="icon" viewBox="0 0 24 24"><path d="M12 12c-2-3-5.5-4-8-2-2.5 2-2.5 6 0 8 2.5 2 6 1 8-2 2 3 5.5 4 8 2 2.5-2 2.5-6 0-8-2.5-2-6-1-8 2z"></path></svg>
                            æ— å°½æ¨¡å¼
                        </button>
                    </div>
                </div>
            `;

            charContainer.innerHTML = '';
            if(chars.length === 0) {
                 charContainer.innerHTML = '<div style="color:var(--text-muted); font-size:12px; width:100%; text-align:center;">æš‚æ— ä¸»è¦è§’è‰²ä»‹ç»</div>';
            } else {
                chars.forEach(c => {
                    const avatarContent = c.avatar 
                        ? `<img src="${c.avatar}" style="width:100%;height:100%;object-fit:cover;">`
                        : `<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#fff;"><svg class="icon" style="width:32px;height:32px;" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></div>`;

                    const item = document.createElement('div');
                    item.className = 'char-item';
                    item.innerHTML = `
                        <div class="char-avatar">
                            ${avatarContent}
                        </div>
                        <div class="char-name">${c.name}</div>
                    `;
                    charContainer.appendChild(item);
                });
            }
        }

        // === æ–°å¢ï¼šå­—ä½“ç¾åŒ–é€»è¾‘ ===
        function applyCustomFont() {
            const url = document.getElementById('customFontUrl').value.trim();
            if(!url) return;
            
            if (url.endsWith('.css') || url.includes('fonts.googleapis.com')) {
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = url;
                document.head.appendChild(link);
            } else {
                const style = document.createElement('style');
                style.innerHTML = `
                    @font-face { font-family: 'UserCustomFont'; src: url('${url}'); }
                    body { font-family: 'UserCustomFont', var(--font-main) !important; }
                `;
                document.head.appendChild(style);
            }
            
            localStorage.setItem(FONT_STORAGE, url);
            showToastMsg("âœ¨ å­—ä½“å·²åº”ç”¨");
        }

        function loadCustomFont() {
            const url = localStorage.getItem(FONT_STORAGE);
            if(url) {
                document.getElementById('customFontUrl').value = url;
                const style = document.createElement('style');
                if (url.endsWith('.css') || url.includes('fonts.googleapis.com')) {
                     const link = document.createElement('link');
                     link.rel = 'stylesheet';
                     link.href = url;
                     document.head.appendChild(link);
                } else {
                    style.innerHTML = `
                        @font-face { font-family: 'UserCustomFont'; src: url('${url}'); }
                        body { font-family: 'UserCustomFont', var(--font-main) !important; }
                    `;
                    document.head.appendChild(style);
                }
            }
        }

        // åˆ‡æ¢è§†å›¾é€»è¾‘
        function switchView(viewName) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            const target = document.getElementById('view-' + viewName);
            if (target) target.classList.add('active');

            if (viewName === 'gallery') {
                renderGallery();
            }

            document.querySelectorAll('.dock-item').forEach(el => el.classList.remove('active'));
            
            const dockItems = document.querySelectorAll('.dock-item');
            const viewMap = {
                'hub': 0,
                'gallery': 1,
                'shop': 2,
                'persona': 3,
                'settings': 4
            };
            
            const index = viewMap[viewName];
            if (index !== undefined && dockItems[index]) {
                dockItems[index].classList.add('active');
            }
        }

        // ç™»å½•é€»è¾‘
        function enterHub() {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                const card = document.querySelector('.login-card');
                card.style.transform = 'translateX(10px)';
                setTimeout(() => card.style.transform = 'translateX(0)', 100);
                setTimeout(() => card.style.transform = 'translateX(-10px)', 200);
                setTimeout(() => card.style.transform = 'translateX(0)', 300);
                return;
            }
            document.getElementById('displayName').textContent = username;
            localStorage.setItem(USERNAME_STORAGE, username);
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainHub').style.display = 'block';
            switchView('hub');
        }

        function showInstanceDetail() {
            switchView('detail');
        }

        // ===== æ¸¸æˆæµç¨‹ =====
        function startGame(mode) {
            if (mode === 'start' || mode === 'endless') {
                if (!currentPersonaId) {
                    openPersonaModal(mode); 
                    return;
                }
            }

            const mainHub = document.getElementById('mainHub');
            const game = document.getElementById('gameContainer');
            const dock = document.querySelector('.dock-nav');

            if (mainHub) mainHub.style.display = 'none';
            if (dock) dock.style.display = 'none';
            if (game) game.style.display = 'block';
            
            updateGameDisplayName();

            // æ€»æ˜¯ä½¿ç”¨ activeStoryData (å®ƒé€šè¿‡å¼•ç”¨æŒ‡å‘ currentDungeon.scripts)
            if (mode === 'continue') {
                const saveRaw = localStorage.getItem('infinite.save');
                if (saveRaw) {
                    const save = JSON.parse(saveRaw);
                    activeStoryData.memory = save.memory || ''; 
                    loadScene(save.currentSceneId);
                    return;
                } else {
                    alert("æ²¡æœ‰æ‰¾åˆ°è‡ªåŠ¨å­˜æ¡£ï¼Œå°†å¼€å§‹æ–°æ¸¸æˆ");
                }
            }

            if (mode !== 'continue') {
                activeStoryData.memory = "æ•…äº‹å¼€ç«¯ã€‚";
                localStorage.removeItem('infinite.save');
            }

            let firstScene = 'start';
            if (mode === 'endless' && activeStoryData['plotBeginAi']) {
                firstScene = 'plotBeginAi';
            } else if (!activeStoryData[firstScene]) {
                const keys = Object.keys(activeStoryData);
                if (keys.length > 0) firstScene = keys[0];
            }
            
            loadScene(firstScene);
        }

        function exitGame() {
            const mainHub = document.getElementById('mainHub');
            const game = document.getElementById('gameContainer');
            const dock = document.querySelector('.dock-nav');

            if (game) game.style.display = 'none';
            if (mainHub) mainHub.style.display = 'block';
            if (dock) dock.style.display = 'flex';
            switchView('detail');
        }

        function saveProgress(showToast = false) {
            // è‡ªåŠ¨å­˜æ¡£ï¼Œä»…å­˜åŸºæœ¬ä¿¡æ¯
            const saveState = {
                currentSceneId: currentSceneId || 'start',
                memory: activeStoryData.memory || "",
                timestamp: Date.now()
            };
            localStorage.setItem('infinite.save', JSON.stringify(saveState));
            if (showToast) showToastMsg("ğŸ’¾ è‡ªåŠ¨å­˜æ¡£å·²æ›´æ–°");
        }

        // ==========================================
        //  ä¿®å¤ç‰ˆï¼šæ¸²æŸ“è®°å¿†å›å»Š (åŠ¨æ€è¯»å– Key)
        // ==========================================
        function renderGallery() {
            const container = document.getElementById('storyLog'); 
            if (!container) return;

            const dungeonKey = 'dungeon_' + (currentDungeon.meta.title || 'custom'); 
            const allSaves = JSON.parse(localStorage.getItem('infinite.all_saves') || '{}');
            const dungeonSaves = Array.isArray(allSaves[dungeonKey]) ? allSaves[dungeonKey] : [null, null, null];

            if (dungeonSaves.every(s => s === null)) {
                container.innerHTML = `
                    <div style="text-align:center; color:var(--text-muted); padding:40px 20px;">
                        <div style="font-size:40px; margin-bottom:10px; opacity:0.3;">ğŸ“‚</div>
                        <div>æš‚æ—  [${currentDungeon.meta.title}] çš„å­˜æ¡£</div>
                        <div style="font-size:12px; opacity:0.6; margin-top:5px;">è¯·åœ¨æ¸¸æˆå†…ç‚¹å‡»â€œå­˜æ¡£â€æŒ‰é’®</div>
                    </div>`;
                return;
            }

            let html = '';
            dungeonSaves.forEach((save, index) => {
                if (!save) return;

                html += `
                    <div class="gallery-item" id="gallery-item-${index}">
                        <div class="gallery-header" onclick="toggleGalleryItem(${index})">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <span style="background:rgba(255,255,255,0.1); padding:2px 8px; border-radius:6px; font-size:12px;">å­˜æ¡£ 0${index + 1}</span>
                                <span style="font-weight:bold; font-size:15px; color:var(--text-main); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:140px;">${save.dungeonName}</span>
                            </div>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <span style="font-size:11px; color:var(--text-muted);">${save.lastPlayed.split(' ')[0]}</span>
                                <span class="gallery-toggle-icon" style="font-size:10px; opacity:0.5;">â–¼</span>
                            </div>
                        </div>
                        
                        <div class="gallery-content">
                            <div style="background:rgba(0,0,0,0.2); padding:12px; border-radius:8px; margin-bottom:12px;">
                                <div style="font-size:12px; color:var(--primary); margin-bottom:4px; font-weight:bold; display:flex; justify-content:space-between;">
                                    <span>å‰§æƒ…æ¢—æ¦‚</span>
                                    <span style="opacity:0.5; font-weight:normal;">${save.lastPlayed.split(' ')[1]}</span>
                                </div>
                                <div style="font-size:13px; color:var(--text-muted); line-height:1.6; text-align:justify; white-space: pre-wrap;">${save.summary || "ï¼ˆæš‚æ— æ€»ç»“ï¼‰"}</div>
                            </div>

                            <div style="text-align:right;">
                                <button class="btn-glow" style="padding:6px 16px; font-size:12px; width:auto; display:inline-flex; border-radius:8px;" onclick="loadGameFromSlot(${index})">
                                    <svg class="icon" style="margin-right:4px; width:14px; height:14px;" viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                                    è¯»å–è®°å¿†
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function toggleGalleryItem(index) {
            const item = document.getElementById(`gallery-item-${index}`);
            if(item) {
                item.classList.toggle('open');
            }
        }

        function loadGameFromSlot(slotIndex) {
            const dungeonKey = 'dungeon_' + (currentDungeon.meta.title || 'custom');
            const allSaves = JSON.parse(localStorage.getItem('infinite.all_saves') || '{}');
            const saves = allSaves[dungeonKey];
            
            if (saves && saves[slotIndex]) {
                const save = saves[slotIndex];
                
                // æ¢å¤å†…å­˜å’Œåœºæ™¯
                activeStoryData.memory = save.memory;
                loadScene(save.sceneId);
                
                // æ›´æ–°è‡ªåŠ¨å­˜æ¡£
                localStorage.setItem('infinite.save', JSON.stringify(save));

                document.getElementById('mainHub').style.display = 'none';
                document.querySelector('.dock-nav').style.display = 'none';
                document.getElementById('gameContainer').style.display = 'block';
                
                showToastMsg(`ğŸ“– è¯»å–å­˜æ¡£ 0${slotIndex + 1} æˆåŠŸ`);
            } else {
                alert("å­˜æ¡£æ•°æ®ä¸¢å¤±");
            }
        }

        // ==========================================
        //  æ ¸å¿ƒä¿®å¤ï¼šloadScene æ™ºèƒ½æ¥ç®¡é€»è¾‘
        // ==========================================
        async function loadScene(sceneId) {
            currentSceneId = sceneId;
            saveProgress(false); 

            let scene = activeStoryData[sceneId];
            const bgEl = document.getElementById('gameBg');
            const optionsEl = document.getElementById('gameOptions');

            if (!scene && sceneId.startsWith('ai_')) {
                scene = {
                    type: 'ai',
                    prompt: `ï¼ˆæ¥ç»­å‰§æƒ…ï¼‰è¯·ç»§ç»­åˆšæ‰çš„æ•…äº‹ã€‚åœºæ™¯ID: ${sceneId}ã€‚`,
                    bg: ''
                };
            }

            if (!scene) {
                alert('å‰§æœ¬ç»“æŸæˆ–åœºæ™¯ä¸¢å¤±ï¼š' + sceneId);
                exitGame();
                return;
            }

            if (bgEl && scene.bg) {
                bgEl.style.backgroundImage = `url(${scene.bg})`;
            }

            if (optionsEl) optionsEl.innerHTML = '';

            if (!scene.type || scene.type === 'fixed') {
                const allPersonas = loadPersonas();
                const myPersona = allPersonas.find(p => p.id === currentPersonaId);
                const playerName = myPersona ? myPersona.name : "ä½ ";
                let displayText = scene.text || '';
                displayText = displayText.replace(/{{user}}/g, playerName);
                
                typeWriter(displayText);
                
                if (scene.options && scene.options.length) {
                    scene.options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = 'game-option-btn';
                        btn.textContent = opt.text || opt.label; 
                        btn.onclick = () => {
                            if (opt.nextScene && activeStoryData[opt.nextScene]) {
                                loadScene(opt.nextScene);
                            } else {
                                // æ™ºèƒ½æ¥ç®¡ï¼šæ²¡æœ‰ä¸‹ä¸€ç« é…ç½®ï¼Œè½¬AIç”Ÿæˆ
                                const nextId = opt.nextScene || ('ai_gen_' + Date.now());
                                activeStoryData[nextId] = {
                                    type: 'ai',
                                    bg: scene.bg, 
                                    prompt: `ï¼ˆæ¥ç»­å‰§æƒ…ï¼‰ç©å®¶åšå‡ºäº†é€‰æ‹©ï¼šâ€œ${opt.text}â€ã€‚è¯·æ ¹æ®è¿™ä¸ªé€‰æ‹©ç»§ç»­æ’°å†™åç»­å‰§æƒ…ï¼Œä¿æŒæ²‰æµ¸æ„Ÿã€‚`
                                };
                                loadScene(nextId);
                            }
                        };
                        optionsEl.appendChild(btn);
                    });
                    
                    // ç‚¹å‡»æ–‡æœ¬æ¡†ç»§ç»­çš„ä¼˜åŒ–
                    if (scene.options.length === 1 && scene.options[0].text === "ç»§ç»­") {
                        const box = document.getElementById('gameTextBox');
                        if(box) {
                             box.onclick = () => {
                                 if (isTyping) { skipTyping(); return; } 
                                 const opt = scene.options[0];
                                 if (opt.nextScene && activeStoryData[opt.nextScene]) {
                                     loadScene(opt.nextScene);
                                 } else {
                                     const nextId = opt.nextScene || ('ai_gen_' + Date.now());
                                     activeStoryData[nextId] = {
                                         type: 'ai',
                                         bg: scene.bg,
                                         prompt: `ï¼ˆæ¥ç»­å‰§æƒ…ï¼‰ç»§ç»­å‰§æƒ…ã€‚`
                                     };
                                     loadScene(nextId);
                                 }
                             };
                        }
                    } else {
                         const box = document.getElementById('gameTextBox');
                         if(box) {
                             box.onclick = () => { if (isTyping) skipTyping(); };
                         }
                    }
                }
                return;
            }

            if (scene.type === 'ai') {
                const textEl = document.getElementById('gameText');
                if (textEl) {
                    textEl.innerHTML = 'âš¡ æ­£åœ¨è¿æ¥ç¥ç»å…ƒ...<br><span style="font-size:12px;opacity:0.6;">æ­£åœ¨ç”Ÿæˆå‰§æƒ…...</span>';
                }

                // AIç”Ÿæˆï¼šä¼ å…¥ currentSceneId æ–¹ä¾¿ AI ç†è§£è¿›åº¦
                const generated = await generateAiSceneText(sceneId, scene, activeStoryData);
                
                if (typeof generated === 'string' && generated.startsWith('âŒ')) {
                    typeWriter(generated); 
                    const btn = document.createElement('button');
                    btn.className = 'game-option-btn';
                    btn.textContent = 'é‡è¯•';
                    btn.onclick = () => loadScene(sceneId);
                    optionsEl.appendChild(btn);
                    return;
                }

                const finalText = generated.text || (typeof generated === 'string' ? generated : 'AI ç”Ÿæˆäº†ç©ºå†…å®¹');
                typeWriter(finalText);

                if (generated.options && Array.isArray(generated.options) && generated.options.length) {
                    optionsEl.innerHTML = '';
                    generated.options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = 'game-option-btn';
                        btn.textContent = opt.text;
                        btn.onclick = () => {
                            let nextId = opt.nextScene;
                            if (!nextId || nextId === 'null') {
                                nextId = 'ai_next_' + Date.now();
                                activeStoryData[nextId] = {
                                    type: 'ai',
                                    bg: scene.bg, 
                                    prompt: `ç”¨æˆ·é€‰æ‹©äº†ï¼š${opt.text}ã€‚è¯·æ ¹æ®è¿™ä¸ªé€‰æ‹©ç»§ç»­å‰§æƒ…ã€‚`
                                };
                            }
                            loadScene(nextId);
                        };
                        optionsEl.appendChild(btn);
                    });
                } else {
                    const btn = document.createElement('button');
                    btn.className = 'game-option-btn';
                    btn.textContent = 'ç»§ç»­';
                    btn.onclick = () => loadScene('ai_next_' + Date.now());
                    optionsEl.appendChild(btn);
                }
            }
        }

        // ==========================================
        //  ğŸ§  å‡çº§ç‰ˆ AI æ ¸å¿ƒï¼šæ³¨å…¥ä¸–ç•Œè§‚ä¸è§’è‰²è®¾å®š
        // ==========================================
        async function generateAiSceneText(sceneId, scene, activeScripts) {
            const apiConfig = JSON.parse(localStorage.getItem('apiConfig') || '{}');
            if (!apiConfig.url || !apiConfig.key) {
                return "âŒ è¯·å…ˆåœ¨â€œç³»ç»Ÿè®¾ç½®â€ä¸­é…ç½® API Key";
            }

            const memory = activeScripts.memory || "æ•…äº‹å¼€å§‹ã€‚";
            const prompt = scene.prompt || "ç»§ç»­å‰§æƒ…ã€‚";
            
            const allPersonas = loadPersonas();
            const myPersona = allPersonas.find(p => p.id === currentPersonaId) || { name: "æ—…è¡Œè€…", desc: "æœªçŸ¥" };

            // æ„å»ºä¸–ç•Œè§‚ä¸NPCåå†Œ
            const worldSetting = currentDungeon.meta.desc || "ä¸€ä¸ªæœªçŸ¥çš„ä¸–ç•Œ";
            
            let npcRoster = "æš‚æ— ç‰¹å®šNPCä¿¡æ¯";
            if (currentDungeon.characters && currentDungeon.characters.length > 0) {
                npcRoster = currentDungeon.characters.map(c => {
                    return `- ${c.name}${c.desc ? ' (' + c.desc + ')' : ''}`;
                }).join("\n");
            }

            const systemPrompt = `
ä½ æ˜¯ä¸€ä¸ªé«˜è‡ªç”±åº¦æ–‡å­—å†’é™©æ¸¸æˆçš„ AI å¯¼æ¼” (DM)ã€‚

ã€ğŸŒ ä¸–ç•Œè§‚è®¾å®šã€‘ï¼š
${worldSetting}

ã€ğŸ‘¥ ç™»åœºè§’è‰²åå½•ã€‘ï¼š
${npcRoster}

ã€ğŸ‘¤ ç©å®¶å½“å‰äººè®¾ã€‘ï¼š
- å§“åï¼š${myPersona.name}
- è®¾å®šï¼š${myPersona.desc}
(è¯·è®©ç©å®¶çš„é­é‡å’Œäº’åŠ¨ç¬¦åˆä¸Šè¿°äººè®¾)

ã€ğŸ“œ å‰æƒ…æè¦ã€‘ï¼š
${memory.slice(-2000)} (åªä¿ç•™æœ€è¿‘è®°å¿†)

ã€âš¡ ä»»åŠ¡æŒ‡ä»¤ã€‘ï¼š
è¯·æ ¹æ®å‰æƒ…æè¦å’Œç©å®¶çš„æœ€æ–°é€‰æ‹©ï¼Œæ¥ç»­ç”Ÿæˆä¸€æ®µå‰§æƒ…ã€‚
1. **æ²‰æµ¸æ„Ÿ**ï¼šç¯å¢ƒæå†™è¦ç»†è…»ï¼Œç¬¦åˆä¸–ç•Œè§‚ã€‚å°è¯´ä½“ã€‚300å­—å·¦å³ã€‚
2. **è§’è‰²æ‰®æ¼”**ï¼šNPC çš„å¯¹è¯é£æ ¼å¿…é¡»ç¬¦åˆå…¶è®¾å®šã€‚
3. **æ ¼å¼è¦æ±‚**ï¼šè¯·ä»…è¾“å‡ºæ ‡å‡†çš„ JSON æ ¼å¼ï¼Œä¸è¦åŒ…å« markdown ä»£ç å—æ ‡è®°ã€‚
JSON ç»“æ„ï¼š
{
  "text": "å‰§æƒ…æ­£æ–‡ï¼ˆæ”¯æŒHTMLæ¢è¡Œ<br>ï¼‰...",
  "options": [
    { "text": "é€‰é¡¹A", "nextScene": null },
    { "text": "é€‰é¡¹B", "nextScene": null }
  ],
  "new_memory": "ä¸€å¥è¯æ¦‚æ‹¬è¿™æ®µå‰§æƒ…ï¼ˆç”¨äºå­˜å…¥é•¿æœŸè®°å¿†ï¼‰"
}`;

            try {
                let fetchUrl = apiConfig.url;
                if (!fetchUrl.endsWith('/chat/completions')) {
                    fetchUrl = fetchUrl.replace(/\/$/, '') + '/chat/completions';
                }

                const response = await fetch(fetchUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiConfig.key}`
                    },
                    body: JSON.stringify({
                        model: apiConfig.model || "gpt-3.5-turbo",
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: `(å½“å‰åœºæ™¯ ID: ${sceneId})\n${prompt}` }
                        ],
                        temperature: 0.85 
                    })
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);

                const data = await response.json();
                const content = data.choices[0].message.content;

                try {
                    const cleanContent = content.replace(/```json/g, '').replace(/```/g, '').trim();
                    const jsonResult = JSON.parse(cleanContent);
                    
                    if (jsonResult.new_memory) {
                        activeScripts.memory += "\n" + jsonResult.new_memory;
                        if (activeScripts.memory.length > 3000) {
                             activeScripts.memory = activeScripts.memory.substring(activeScripts.memory.length - 3000);
                        }
                    }
                    return jsonResult;

                } catch (e) {
                    return { text: content, options: [] };
                }

            } catch (err) {
                console.error(err);
                return `âŒ ç”Ÿæˆå¤±è´¥: ${err.message}`;
            }
        }

        function typeWriter(text) {
            const textEl = document.getElementById('gameText');
            if (!textEl) return;

            if (typingTimer) clearTimeout(typingTimer);
            typingText = text;
            typingIndex = 0;
            isTyping = true;
            textEl.textContent = '';

            const step = () => {
                if (!isTyping) return;
                if (typingIndex >= typingText.length) {
                    textEl.textContent = typingText;
                    isTyping = false;
                    return;
                }
                textEl.textContent += typingText.charAt(typingIndex);
                typingIndex += 1;
                typingTimer = setTimeout(step, 30);
            };

            step();
        }

        function skipTyping() {
            if (!isTyping) return;
            const textEl = document.getElementById('gameText');
            if (!textEl) return;
            if (typingTimer) clearTimeout(typingTimer);
            isTyping = false;
            textEl.textContent = typingText;
        }

        // ==========================================
        //  AI å‰§æƒ…æ€»ç»“ (è‡ªåŠ¨æ‹‰å–è®°å¿†ç”Ÿæˆæ€»ç»“)
        // ==========================================
        async function generateSummary(memoryText) {
            const configRaw = localStorage.getItem('apiConfig');
            if (!configRaw) return "ï¼ˆæœªé…ç½®APIï¼Œæ— æ³•ç”Ÿæˆæ€»ç»“ï¼‰";
            const config = JSON.parse(configRaw);
            if (!config.key) return "ï¼ˆAPI Keyä¸ºç©ºï¼Œæ— æ³•ç”Ÿæˆæ€»ç»“ï¼‰";

            const recentContext = memoryText.slice(-4000); 

            let baseUrl = config.url || 'https://api.openai.com/v1';
            baseUrl = baseUrl.replace(/\/+$/, '');
            if (baseUrl.endsWith('/chat/completions')) baseUrl = baseUrl.replace(/\/chat\/completions$/, '');
            if (!baseUrl.endsWith('/v1')) baseUrl += '/v1';
            const finalUrl = baseUrl + '/chat/completions';

            const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å‰§æƒ…è®°å½•å‘˜ã€‚è¯·æ ¹æ®æä¾›çš„æ¸¸æˆå‰§æƒ…ç‰‡æ®µï¼ˆæœ€åçº¦20è½®å¯¹è¯ï¼‰ï¼Œå†™ä¸€æ®µå‰§æƒ…æ€»ç»“ã€‚
            è¦æ±‚ï¼š
            1. ä½¿ç”¨ç¬¬ä¸‰äººç§°ã€‚
            2. é‡ç‚¹æ¦‚æ‹¬å‘ç”Ÿçš„å…³é”®äº‹ä»¶ã€ä¸»è§’çš„é€‰æ‹©ä»¥åŠå½“å‰çš„çŠ¶æ€ã€‚
            3. å­—æ•°æ§åˆ¶åœ¨600å­—ä»¥å†…ã€‚
            4. è¯­æ°”å®¢è§‚å†·é™ï¼Œä»¥çº¿æ€§æ–¹å¼è®°å½•æ•…äº‹ç»å†ï¼Œå°½é‡å…¨åœ°æ€»ç»“ä¿¡æ¯ã€‚`;

            try {
                const res = await fetch(finalUrl, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': 'Bearer ' + config.key 
                    },
                    body: JSON.stringify({
                        model: config.model || 'gpt-3.5-turbo',
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: "å‰§æƒ…ç‰‡æ®µï¼š\n" + recentContext }
                        ],
                        temperature: 0.7
                    })
                });

                if (!res.ok) throw new Error(res.statusText);

                const data = await res.json();
                return data.choices?.[0]?.message?.content || "ï¼ˆAI æ€»ç»“ç”Ÿæˆå¤±è´¥ï¼‰";
            } catch (e) {
                console.error("æ€»ç»“ç”Ÿæˆå‡ºé”™:", e);
                return "ï¼ˆç½‘ç»œè¿æ¥å¤±è´¥ï¼Œæš‚æ— è¯¦ç»†æ€»ç»“ï¼‰" + memoryText.slice(-100) + "...";
            }
        }
        
        // API é…ç½®ä¿å­˜
        function saveApiConfig() {
            const apiName = document.getElementById('apiName').value.trim();
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const apiKey = document.getElementById('settingsApiKey').value.trim();
            const apiModel = document.getElementById('apiModel').value.trim();
            
            if (!apiName || !apiUrl || !apiKey) {
                alert('âš ï¸ è¯·å¡«å†™å®Œæ•´çš„ API é…ç½®ä¿¡æ¯');
                return;
            }
            
            const config = {
                name: apiName,
                url: apiUrl,
                key: apiKey,
                model: apiModel || 'gpt-3.5-turbo'
            };
            
            localStorage.setItem('apiConfig', JSON.stringify(config));
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = 'âœ… é…ç½®å·²ä¿å­˜';
            btn.style.background = '#10b981';
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = '';
            }, 2000);
        }

        function loadApiConfig() {
            const savedConfig = localStorage.getItem('apiConfig');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    document.getElementById('apiName').value = config.name || '';
                    document.getElementById('apiUrl').value = config.url || '';
                    document.getElementById('settingsApiKey').value = config.key || '';
                    
                    if (config.model) {
                        const modelSelect = document.getElementById('apiModel');
                        if (!Array.from(modelSelect.options).some(opt => opt.value === config.model)) {
                             const option = document.createElement('option');
                             option.value = config.model;
                             option.textContent = config.model;
                             modelSelect.appendChild(option);
                        }
                        modelSelect.value = config.model;
                    }
                } catch (e) {
                    console.error('Config load failed', e);
                }
            }
        }

        async function testApiConnection() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const apiKey = document.getElementById('settingsApiKey').value.trim();
            const resultDiv = document.getElementById('apiTestResult');
            const modelSelect = document.getElementById('apiModel');

            if (!apiUrl || !apiKey) {
                showApiTestResult(' è¯·å…ˆå¡«å†™ API URL å’Œ Key', 'error');
                return;
            }

            showApiTestResult('ğŸ”„ æ­£åœ¨æµ‹è¯•è¿æ¥...', 'loading');

            try {
                let modelsUrl = apiUrl.replace(/\/$/, '');
                if (modelsUrl.endsWith('/v1')) modelsUrl = modelsUrl.replace(/\/v1$/, '');
                if (modelsUrl.endsWith('/chat/completions')) modelsUrl = modelsUrl.replace(/\/chat\/completions$/, '');
                modelsUrl += '/models';
                
                const res = await fetch(modelsUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + apiKey,
                        'Content-Type': 'application/json'
                    }
                });

                if (!res.ok) {
                    const errorText = await res.text();
                    showApiTestResult(` è¿æ¥å¤±è´¥: ${res.status} ${res.statusText}`, 'error');
                    console.error('API Error:', errorText);
                    return;
                }

                const data = await res.json();
                
                if (data.data && Array.isArray(data.data)) {
                    const models = data.data;
                    showApiTestResult(` è¿æ¥æˆåŠŸï¼æ‰¾åˆ° ${models.length} ä¸ªå¯ç”¨æ¨¡å‹`, 'success');
                    
                    modelSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©æ¨¡å‹ --</option>';
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = model.id;
                        modelSelect.appendChild(option);
                    });

                    const savedConfig = localStorage.getItem('apiConfig');
                    if (savedConfig) {
                        try {
                            const config = JSON.parse(savedConfig);
                            if (config.model) {
                                modelSelect.value = config.model;
                            }
                        } catch (e) {}
                    }
                } else {
                    showApiTestResult('âœ… è¿æ¥æˆåŠŸï¼ä½†æœªèƒ½è·å–æ¨¡å‹åˆ—è¡¨ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥æ¨¡å‹å', 'warning');
                }
            } catch (error) {
                showApiTestResult(` ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
                console.error('Fetch error:', error);
            }
        }

        function showApiTestResult(message, type) {
            const resultDiv = document.getElementById('apiTestResult');
            if (!resultDiv) return;

            const colors = {
                success: 'background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.4); color: #10b981;',
                error: 'background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); color: #ef4444;',
                warning: 'background: rgba(245, 158, 11, 0.2); border: 1px solid rgba(245, 158, 11, 0.4); color: #f59e0b;',
                loading: 'background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); color: #3b82f6;'
            };

            resultDiv.style.cssText = colors[type] || colors.loading;
            resultDiv.textContent = message;
            resultDiv.style.display = 'block';
        }

        function changeTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-theme') === theme) {
                    btn.classList.add('active');
                }
            });
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'purple';
            changeTheme(savedTheme);
        }

        function loadPersonas() {
            try {
                const raw = localStorage.getItem(PERSONA_STORAGE);
                if (!raw) return [];
                const list = JSON.parse(raw);
                return Array.isArray(list) ? list : [];
            } catch (e) {
                return [];
            }
        }

        function savePersonas(list) {
            localStorage.setItem(PERSONA_STORAGE, JSON.stringify(list));
        }

        function initPersonas() {
            renderPersonaStrip();
            const box = document.getElementById('gameTextBox');
            if (box) {
                box.addEventListener('click', () => {
                    if (isTyping) {
                        skipTyping();
                    }
                });
            }
        }
        
        function renderPersonaStrip() {
            const strip = document.getElementById('persona-strip');
            if (!strip) return;
            
            strip.className = 'persona-strip-container'; 
            strip.innerHTML = '';

            const newBtn = document.createElement('div');
            newBtn.className = 'story-ring';
            newBtn.onclick = () => resetPersonaForm(); 
            const newActive = currentPersonaId === null ? 'border: 2px solid var(--primary);' : '';

            newBtn.innerHTML = `
                <div class="story-avatar-wrap new-btn" style="${newActive}">
                    <div class="story-avatar-inner">
                        <span style="font-size:24px; color:var(--text-main);">+</span>
                    </div>
                </div>
                <div class="story-name">æ–°èº«ä»½</div>
            `;
            strip.appendChild(newBtn);

            const list = loadPersonas();
            list.forEach((p) => {
                const item = document.createElement('div');
                item.className = 'story-ring';
                item.onclick = () => loadPersonaDetail(p); 
                
                const imgContent = p.avatar 
                    ? `<img src="${p.avatar}">` 
                    : `<span style="font-size:20px">ğŸ‘¤</span>`;

                const isSelected = (currentPersonaId === p.id);
                const activeStyle = isSelected ? 'border: 2px solid var(--primary); transform: scale(1.1); transition: all 0.2s;' : '';

                item.innerHTML = `
                    <div class="story-avatar-wrap" style="${activeStyle}">
                        <div class="story-avatar-inner">
                            ${imgContent}
                        </div>
                    </div>
                    <div class="story-name">${p.name || 'æœªå‘½å'}</div>
                `;
                strip.appendChild(item);
            });
        }

        function savePersona() {
            const name = document.getElementById('persona-name').value.trim();
            const desc = document.getElementById('persona-desc').value.trim();
            const imgEl = document.getElementById('persona-avatar-preview');
            const avatar = (imgEl.style.display !== 'none' && imgEl.src) ? imgEl.src : '';
            
            if (!name) {
                showToastMsg("âŒ è‡³å°‘èµ·ä¸ªåå­—å§~");
                return;
            }

            let list = loadPersonas();

            try {
                if (currentPersonaId) {
                    const index = list.findIndex(p => p.id === currentPersonaId);
                    if (index !== -1) {
                        list[index] = { ...list[index], name, desc, avatar };
                        showToastMsg("ğŸ’¾ èº«ä»½ä¿¡æ¯å·²æ›´æ–°");
                    }
                } else {
                    const newId = Date.now();
                    const newP = { id: newId, name, desc, avatar };
                    list.push(newP);
                    currentPersonaId = newId; 
                    showToastMsg("âœ¨ æ–°èº«ä»½å·²åˆ›å»º");
                }

                savePersonas(list);
                renderPersonaStrip(); 

            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    alert(" ä¿å­˜å¤±è´¥ï¼šå›¾ç‰‡å¤ªå¤§äº†ï¼\næµè§ˆå™¨å­˜ä¸ä¸‹äº†ï¼Œè¯·æ¢å¼ å°å›¾æˆ–è€…ä¸ä¼ å¤´åƒã€‚");
                } else {
                    console.error(e);
                    alert("ä¿å­˜å‡ºé”™ï¼š" + e.message);
                }
            }
        }

        function resetPersonaForm() {
            document.getElementById('persona-name').value = '';
            document.getElementById('persona-desc').value = '';
            document.getElementById('persona-avatar-preview').style.display = 'none';
            document.getElementById('persona-avatar-preview').src = '';
            document.getElementById('persona-placeholder').style.display = 'block';
            
            currentPersonaId = null; 
            
            showToastMsg(" åˆ‡æ¢è‡³æ–°å»ºæ¨¡å¼");
            renderPersonaStrip();
        }

        function loadPersonaDetail(p) {
            document.getElementById('persona-name').value = p.name || '';
            document.getElementById('persona-desc').value = p.desc || '';
            currentPersonaId = p.id; 
            
            if (p.avatar) {
                const img = document.getElementById('persona-avatar-preview');
                img.src = p.avatar;
                img.style.display = 'block';
                document.getElementById('persona-placeholder').style.display = 'none';
            } else {
                document.getElementById('persona-avatar-preview').style.display = 'none';
                document.getElementById('persona-placeholder').style.display = 'block';
            }
            renderPersonaStrip(); 
        }
        
        function onAvatarFileChange(e) {
             const file = e.target.files[0];
             if(!file) return;

             if (file.size > 2 * 1024 * 1024) {
                 showToastMsg(" å›¾ç‰‡è¾ƒå¤§ï¼Œæ­£åœ¨å‹ç¼©...");
             }

             const reader = new FileReader();
             reader.onload = function(evt) {
                 const img = new Image();
                 img.src = evt.target.result;
                 img.onload = function() {
                     const canvas = document.createElement('canvas');
                     const ctx = canvas.getContext('2d');
                     
                     const MAX_SIZE = 300;
                     let width = img.width;
                     let height = img.height;
                     
                     if (width > height) {
                         if (width > MAX_SIZE) {
                             height *= MAX_SIZE / width;
                             width = MAX_SIZE;
                         }
                     } else {
                         if (height > MAX_SIZE) {
                             width *= MAX_SIZE / height;
                             height = MAX_SIZE;
                         }
                     }
                     
                     canvas.width = width;
                     canvas.height = height;
                     ctx.drawImage(img, 0, 0, width, height);
                     
                     const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                     
                     const previewEl = document.getElementById('persona-avatar-preview');
                     previewEl.src = compressedDataUrl;
                     previewEl.style.display = 'block';
                     document.getElementById('persona-placeholder').style.display = 'none';
                 };
             };
             reader.readAsDataURL(file);
        }
        
        function clearMemory() {
             if(confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è®°å¿†å—ï¼Ÿ")) {
                 activeStoryData.memory = "";
                 const container = document.getElementById('storyLog');
                 if(container) container.innerHTML = '<div style="text-align:center; color:#666; padding:20px;">æš‚æ— æ¢ç´¢è®°å½•</div>';
                 
                 localStorage.removeItem('infinite.all_saves');
             }
        }

        // === ç¼–è¾‘å™¨æ ¼å¼é€‚é…å™¨ ===
        function adaptEditorData(json) {
            if (json.worldview && json.main_story) {
                console.log("æ£€æµ‹åˆ°ç¼–è¾‘å™¨æ ¼å¼ï¼Œæ­£åœ¨è½¬æ¢...");
                
                let coverImg = "";
                const firstMain = json.main_story[Object.keys(json.main_story)[0]];
                if (firstMain && firstMain.background) coverImg = firstMain.background;
                
                const newMeta = {
                    title: json.worldview.name || "æœªçŸ¥ä¸–ç•Œ",
                    desc: json.worldview.description || "æš‚æ— ç®€ä»‹",
                    cover: coverImg, 
                    tags: ["ç¼–è¾‘å™¨ä½œå“", "è‡ªå®šä¹‰"]
                };

                const newChars = [];
                if (json.characters) {
                    Object.values(json.characters).forEach(c => {
                        newChars.push({
                            name: c.name,
                            avatar: c.avatar || "",
                            desc: c.description || "" 
                        });
                    });
                }

                const allScenes = { 
                    ...json.main_story, 
                    ...json.side_stories, 
                    ...json.char_routes 
                };
                
                const newScripts = {};
                
                const sceneKeys = Object.keys(allScenes).sort((a, b) => {
                    return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
                });

                sceneKeys.forEach((key, index) => {
                    const scene = allScenes[key];
                    let newOptions = (scene.options || []).map(opt => ({
                        text: opt.label,      
                        nextScene: opt.nextScene 
                    }));

                    if (newOptions.length === 0 && index < sceneKeys.length - 1) {
                         const nextKey = sceneKeys[index + 1];
                         newOptions.push({
                             text: "ç»§ç»­",
                             nextScene: nextKey
                         });
                    }

                    newScripts[key] = {
                        type: 'fixed', 
                        text: scene.text, 
                        bg: scene.background, 
                        options: newOptions
                    };
                });

                if (!newScripts['start']) {
                    if (newScripts['main_1']) {
                        newScripts['start'] = newScripts['main_1'];
                    } else if (sceneKeys.length > 0) {
                        newScripts['start'] = newScripts[sceneKeys[0]];
                    }
                }

                return {
                    meta: newMeta,
                    characters: newChars,
                    scripts: newScripts
                };
            }
            return json;
        }

        function loadCustomStory() {
            const raw = localStorage.getItem(STORY_STORAGE);
            if (!raw) {
                currentDungeon = defaultDungeon;
                activeStoryData = currentDungeon.scripts;
                return;
            }
            try {
                let parsed = JSON.parse(raw);
                parsed = adaptEditorData(parsed);

                if (parsed.meta && parsed.scripts) {
                    currentDungeon = parsed;
                } else if (parsed.start || parsed.main_story) {
                     currentDungeon = {
                        meta: { title: "è‡ªå®šä¹‰å‰§æœ¬", desc: "æœ¬åœ°å‰§æœ¬", cover: "", tags: ["æœ¬åœ°"] },
                        characters: [],
                        scripts: parsed
                    };
                } else {
                    currentDungeon = defaultDungeon;
                }
                
                // å…³é”®åŒæ­¥ï¼šç¡®ä¿ activeStoryData æŒ‡å‘æ–°åŠ è½½çš„å‰§æœ¬è„šæœ¬
                activeStoryData = currentDungeon.scripts;
            } catch (e) {
                console.warn('å‰§æœ¬è§£æå¤±è´¥', e);
                currentDungeon = defaultDungeon;
                activeStoryData = currentDungeon.scripts;
            }
        }
        
        function handleStoryUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let json = JSON.parse(e.target.result);
                    json = adaptEditorData(json); 

                    if (!json.scripts || !json.meta) {
                        throw new Error("æ— æ³•è¯†åˆ«çš„å‰§æœ¬æ ¼å¼ï¼Œè¯·ç¡®è®¤åŒ…å« scripts æˆ– main_story");
                    }

                    localStorage.setItem(STORY_STORAGE, JSON.stringify(json));
                    
                    if(confirm("ä¸Šä¼ æ–°å‰§æœ¬å°†è¦†ç›–å½“å‰å‰¯æœ¬å¹¶é‡ç½®è¿›åº¦ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")) {
                        localStorage.removeItem('infinite.save');
                        localStorage.removeItem('infinite.all_saves');
                        
                        loadCustomStory(); // è¿™ä¼šé‡æ–°åŠ è½½å¹¶åŒæ­¥ activeStoryData
                        renderUI(); 
                        
                        document.getElementById('storyUploadMsg').textContent = `âœ… æˆåŠŸåŠ è½½: ${file.name}`;
                        alert("å‰¯æœ¬å·²æ›´æ–°ï¼");
                        switchView('hub');
                    }
                } catch (err) {
                    console.error(err);
                    alert("å‰§æœ¬æ–‡ä»¶æ ¼å¼é”™è¯¯: " + err.message);
                }
            };
            reader.readAsText(file);
        }

        function resetStory() {
            if(confirm("ç¡®å®šè¦æ¢å¤åˆ°é»˜è®¤çš„ã€Šç´«ç¦åŸè¿·æ¢¦ã€‹å—ï¼Ÿ")) {
                localStorage.removeItem(STORY_STORAGE);
                currentDungeon = defaultDungeon;
                activeStoryData = currentDungeon.scripts;
                renderUI();
                document.getElementById('storyUploadMsg').textContent = "";
                alert('å·²æ¢å¤é»˜è®¤å‰§æœ¬');
            }
        }

        // ==========================================
        //  å­˜æ¡£æ ¸å¿ƒé€»è¾‘
        // ==========================================
        let pendingSaveSlot = null;

        function openSaveSlotModal() {
            const modal = document.getElementById('personaModal');
            const header = modal.querySelector('.modal-header h3');
            const list = document.getElementById('modalPersonaList');
            const empty = document.getElementById('modalEmptyState');

            header.textContent = "é€‰æ‹©å­˜æ¡£ä½ç½®";
            modal.style.display = 'flex';
            empty.style.display = 'none';
            list.style.display = 'grid';
            list.innerHTML = '';

            // ä½¿ç”¨å½“å‰å‰§æœ¬çš„åŠ¨æ€ Key
            const dungeonKey = 'dungeon_' + (currentDungeon.meta.title || 'custom');
            const allSaves = JSON.parse(localStorage.getItem('infinite.all_saves') || '{}');
            const dungeonSaves = Array.isArray(allSaves[dungeonKey]) ? allSaves[dungeonKey] : [null, null, null];

            for (let i = 0; i < 3; i++) {
                const save = dungeonSaves[i];
                const slotNum = i + 1;
                const el = document.createElement('div');
                el.className = 'persona-select-item';
                el.onclick = () => performSave(i);

                const statusText = save ? `${save.lastPlayed}` : "ç©ºå­˜æ¡£ä½";
                const summaryText = save ? (save.summary ? save.summary.substring(0, 20) + "..." : "æš‚æ— æ€»ç»“") : "ç‚¹å‡»å­˜æ¡£";

                el.innerHTML = `
                    <div style="width:40px;height:40px;background:rgba(255,255,255,0.1);border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:bold;">${slotNum}</div>
                    <div style="flex:1;">
                        <div style="font-weight:bold; font-size:14px; color:var(--text-main);">å­˜æ¡£ ${slotNum}</div>
                        <div style="font-size:12px; color:var(--text-muted);">${statusText}</div>
                        <div style="font-size:12px; color:var(--primary); margin-top:2px;">${summaryText}</div>
                    </div>
                    <div style="font-size:12px; padding:4px 8px; background:var(--primary); border-radius:4px;">è¦†ç›–</div>
                `;
                list.appendChild(el);
            }
        }

        async function performSave(slotIndex) {
            document.getElementById('personaModal').style.display = 'none';
            showToastMsg("â³ æ­£åœ¨ç”Ÿæˆå‰§æƒ…æ€»ç»“å¹¶å­˜æ¡£...");

            // ä½¿ç”¨ activeStoryData ç¡®ä¿æ‹¿åˆ°çš„æ˜¯å½“å‰è¿è¡Œå‰§æœ¬çš„è®°å¿†
            const memory = activeStoryData.memory || "";
            let summary = "æ•…äº‹åˆšåˆšå¼€å§‹...";
            
            if (memory.length > 50) {
                summary = await generateSummary(memory);
            } else if (activeStoryData[currentSceneId] && activeStoryData[currentSceneId].text) {
                summary = activeStoryData[currentSceneId].text.substring(0, 50) + "...";
            }

            const now = new Date();
            const timeStr = `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;

            const saveObj = {
                dungeonName: currentDungeon.meta.title || "æœªçŸ¥ä¸–ç•Œ",
                lastPlayed: timeStr,
                memory: memory,
                summary: summary,
                sceneId: currentSceneId || 'start',
                slotIndex: slotIndex
            };

            const dungeonKey = 'dungeon_' + (currentDungeon.meta.title || 'custom');
            let allSaves = JSON.parse(localStorage.getItem('infinite.all_saves') || '{}');
            if (!Array.isArray(allSaves[dungeonKey])) {
                allSaves[dungeonKey] = [null, null, null];
            }
            
            allSaves[dungeonKey][slotIndex] = saveObj;
            localStorage.setItem('infinite.all_saves', JSON.stringify(allSaves));
            
            // åŒæ—¶æ›´æ–°è‡ªåŠ¨å­˜æ¡£
            localStorage.setItem('infinite.save', JSON.stringify(saveObj));

            showToastMsg("âœ… å­˜æ¡£æˆåŠŸï¼è®°å¿†å·²æ›´æ–°");
            
            // å¦‚æœåœ¨è®°å¿†å›å»Šé¡µé¢ï¼Œåˆ·æ–°ä¸€ä¸‹
            const gallery = document.getElementById('view-gallery');
            if (gallery.classList.contains('active')) {
                renderGallery();
            }
        }

        let pendingGameMode = null; 

        function openPersonaModal(mode = null) {
            pendingGameMode = mode;
            const modal = document.getElementById('personaModal');
            const header = modal.querySelector('.modal-header h3');
            if (header) header.textContent = "é€‰æ‹©ä½ çš„èº«ä»½";

            const listContainer = document.getElementById('modalPersonaList');
            const emptyState = document.getElementById('modalEmptyState');
            
            modal.style.display = 'flex';
            listContainer.innerHTML = '';
            
            const list = loadPersonas();
            
            if (list.length === 0) {
                listContainer.style.display = 'none';
                emptyState.style.display = 'block';
            } else {
                listContainer.style.display = 'grid';
                emptyState.style.display = 'none';
                
                list.forEach(p => {
                    const el = document.createElement('div');
                    el.className = `persona-select-item ${currentPersonaId === p.id ? 'active' : ''}`;
                    el.onclick = () => selectPersonaAndStart(p);
                    
                    const avatarHtml = p.avatar 
                        ? `<img src="${p.avatar}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">` 
                        : `<div style="width:40px;height:40px;background:#333;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;">ğŸ‘¤</div>`;
                        
                    el.innerHTML = `
                        ${avatarHtml}
                        <div style="flex:1;">
                            <div style="font-weight:bold; font-size:14px; color:var(--text-main);">${p.name}</div>
                            <div style="font-size:12px; color:var(--text-muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:200px;">${p.desc.substring(0,20)}...</div>
                        </div>
                        ${currentPersonaId === p.id ? '<span style="color:var(--primary);">âœ…</span>' : ''}
                    `;
                    listContainer.appendChild(el);
                });
            }
        }

        const CUSTOM_CSS_STORAGE = 'infinite.custom_css';

        function applyCustomCss() {
            const css = document.getElementById('customCssInput').value;
            localStorage.setItem(CUSTOM_CSS_STORAGE, css);
            injectCustomStyle(css);
            showToastMsg("ğŸ¨ æ ·å¼å·²åº”ç”¨");
        }

        function clearCustomCss() {
            if(confirm("ç¡®å®šè¦æ¸…ç©ºè‡ªå®šä¹‰æ ·å¼å—ï¼Ÿ")) {
                document.getElementById('customCssInput').value = '';
                localStorage.removeItem(CUSTOM_CSS_STORAGE);
                injectCustomStyle(''); 
                showToastMsg("ğŸ—‘ï¸ æ ·å¼å·²é‡ç½®");
            }
        }

        function injectCustomStyle(css) {
            let style = document.getElementById('user-custom-style-tag');
            if (!style) {
                style = document.createElement('style');
                style.id = 'user-custom-style-tag';
                document.head.appendChild(style);
            }
            style.textContent = css;
        }

        function loadCustomCss() {
            const savedCss = localStorage.getItem(CUSTOM_CSS_STORAGE);
            if (savedCss) {
                const input = document.getElementById('customCssInput');
                if (input) input.value = savedCss;
                injectCustomStyle(savedCss);
            }
        }

        loadCustomCss();
        window.onload = init;
    </script>
</body>
</html>
