<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Utopia noteÂ·ä¹Œæ‰˜é‚¦æ‰‹è®°</title>
    <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <style>
        :root {
            /* === ä½ çš„åŸå§‹é…è‰²ç³»ç»Ÿ === */
            --primary: #d946ef;
            --secondary: #8b5cf6;
            --accent: #06b6d4;
            --bg-deep: #0f0720;
            --gradient-holo: linear-gradient(135deg, rgba(217,70,239,0.8), rgba(139,92,246,0.8), rgba(6,182,212,0.8));
            --gradient-glass: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            --glass-surface: rgba(20, 10, 35, 0.4);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.7);
            --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.3);
            --font-main: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', sans-serif;
        }

        [data-theme="white"] { --primary: #5b7aef; --bg-deep: #f5f7fa; --text-main: #1a1a1a; --glass-surface: rgba(255, 255, 255, 0.6); }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-deep);
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
            background-image: radial-gradient(circle at 10% 20%, rgba(217, 70, 239, 0.15) 0%, transparent 40%), radial-gradient(circle at 90% 80%, rgba(6, 182, 212, 0.15) 0%, transparent 40%);
            background-attachment: fixed;
            transition: background 0.5s, color 0.5s;
        }

        .glass-panel { background: var(--glass-surface); backdrop-filter: blur(24px); border: 1px solid var(--glass-border); border-top: 1px solid rgba(255,255,255,0.2); box-shadow: var(--shadow-card); }
        .icon { width: 20px; height: 20px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; display: inline-block; vertical-align: middle; }
        
        /* ç™»å½•é¡µ */
        .login-page { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; position: relative; z-index: 10; }
        .login-card { width: 100%; max-width: 400px; padding: 40px 30px; border-radius: 24px; text-align: center; position: relative; overflow: hidden; }
        .login-title { font-size: 36px; font-weight: 800; margin-bottom: 8px; color: var(--primary); }
        .input-modern { width: 100%; padding: 16px 20px; background: rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; color: var(--text-main); font-size: 16px; outline: none; transition: all 0.3s; margin-bottom: 20px; }
        .btn-glow { width: 100%; padding: 16px; border: none; border-radius: 16px; background: var(--gradient-holo); color: white; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s; }
        .btn-glow:active { transform: scale(0.98); }

        /* ä¸»ç•Œé¢ */
        .main-hub { display: none; padding: 20px 20px 100px 20px; max-width: 1200px; margin: 0 auto; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .user-pill { display: flex; align-items: center; gap: 12px; padding: 8px 16px; border-radius: 100px; background: rgba(255,255,255,0.05); }
        
        /* è§†å›¾å®¹å™¨ */
        .view-section { display: none; animation: fadeIn 0.4s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* å‰¯æœ¬å¡ç‰‡ */
        .grid-layout { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px; }
        .card-instance { border-radius: 24px; overflow: hidden; cursor: pointer; position: relative; height: 200px; }
        .card-cover { height: 100%; width: 100%; position: relative; }
        .card-cover img { width: 100%; height: 100%; object-fit: cover; }
        .card-body { position: absolute; bottom: 0; left: 0; right: 0; padding: 15px; background: linear-gradient(to top, #000, transparent); }
        .card-title { font-size: 18px; font-weight: 700; color: #fff; }
        .card-desc { font-size: 12px; color: #ddd; }

        /* è¯¦æƒ…é¡µ */
        .detail-layout { display: flex; gap: 24px; border-radius: 24px; padding: 24px; margin-bottom: 24px; }
        .detail-cover img { width: 100%; max-width: 300px; border-radius: 16px; }
        .detail-info { flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .tag-row { display: flex; gap: 10px; margin: 10px 0; }
        .tag { padding: 4px 10px; background: rgba(255,255,255,0.1); border-radius: 99px; font-size: 12px; }

        /* ä¸ªäººè®¾å®šä¿®å¤æ ·å¼ */
        .persona-container { max-width: 700px; margin: 0 auto; }
        .persona-strip { display: flex; gap: 15px; overflow-x: auto; padding: 10px 5px; min-height: 80px; }
        .persona-chip { flex: 0 0 auto; text-align: center; cursor: pointer; opacity: 0.6; transition: 0.3s; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .persona-chip.active { opacity: 1; transform: scale(1.05); }
        .persona-avatar { width: 55px; height: 55px; border-radius: 50%; background: var(--gradient-holo); display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px solid transparent; color: white; font-size: 20px; }
        .persona-chip.active .persona-avatar { border-color: #fff; }
        .persona-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .persona-avatar-slot { width: 100px; height: 100px; border-radius: 20px; background: rgba(255,255,255,0.1); border: 1px dashed rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; position: relative; }
        .persona-avatar-slot img { width: 100%; height: 100%; object-fit: cover; }

        /* æ¸¸æˆè¿è¡Œç•Œé¢ */
        .game-container { position: fixed; inset: 0; z-index: 200; display: none; background-color: #000; overflow: hidden; }
        .game-bg { position: absolute; inset: 0; background-size: cover; background-position: center; filter: brightness(0.65); }
        .game-content { position: relative; z-index: 1; display: flex; flex-direction: column; justify-content: flex-end; height: 100%; padding: 20px 16px 40px; }
        .game-text-box { max-width: 900px; margin: 0 auto 16px; background: rgba(0,0,0,0.75); border-radius: 16px; padding: 20px; color: #fff; min-height: 100px; font-size: 16px; line-height: 1.7; border: 1px solid rgba(255,255,255,0.1); white-space: pre-wrap; }
        .game-options { max-width: 900px; margin: 0 auto; display: flex; flex-wrap: wrap; gap: 10px; }
        .game-option-btn { padding: 12px 20px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.6); color: #fff; font-size: 14px; cursor: pointer; transition: 0.2s; }
        .game-option-btn:hover { background: var(--primary); border-color: var(--primary); }
        .game-top-bar { position: absolute; top: 20px; right: 20px; z-index: 20; display: flex; gap: 10px; }
        .game-btn-small { padding: 8px 16px; background: rgba(0,0,0,0.5); border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); color: white; cursor: pointer; backdrop-filter: blur(5px); }

        /* Dock */
        .dock-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; padding: 12px 24px; border-radius: 24px; z-index: 100; }
        .dock-item { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; color: var(--text-muted); cursor: pointer; }
        .dock-item.active { color: var(--primary); transform: scale(1.2); }

        /* Toast */
        #toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.85); color: #fff; padding: 12px 24px; border-radius: 50px; display: none; z-index: 999; border: 1px solid var(--primary); animation: popIn 0.3s; }
        @keyframes popIn { from { transform: translate(-50%, -40%); opacity: 0; } to { transform: translate(-50%, -50%); opacity: 1; } }

        /* è®°å¿†å›æ”¾æ¡† */
        .log-container { background: rgba(0,0,0,0.1); border-radius: 12px; padding: 20px; height: 300px; overflow-y: auto; font-size: 14px; line-height: 1.8; white-space: pre-wrap; color: var(--text-muted); margin-top: 10px; }

        @media (max-width: 768px) {
            .detail-layout { flex-direction: column; }
            .grid-layout { grid-template-columns: 1fr; }
        }
    </style>
    <!-- è‡ªå®šä¹‰ CSS æ³¨å…¥ç‚¹ -->
    <style id="user-custom-css"></style> 
</head>
<body data-theme="purple" onload="init()">

    <div class="aurora-bg"></div>
    <div id="toast">âœ… æ“ä½œæˆåŠŸ</div>
    
    <div id="loginPage" class="login-page">
        <div class="login-card glass-panel">
            <h1 class="login-title">INFINITE LOVE</h1>
            <p class="login-subtitle">Utopia note Â· ä¹Œæ‰˜é‚¦æ‰‹è®°</p>
            <input type="text" class="input-modern" id="username" placeholder="è¯·è¾“å…¥ä½ çš„ä»£å·..." autocomplete="off">
            <button class="btn-glow" onclick="enterHub()">è¿æ¥ç¥ç»å…ƒ</button>
        </div>
    </div>

    <div id="mainHub" class="main-hub">
        <div class="top-bar">
            <div class="user-pill glass-panel">
                <span style="font-weight: 600; font-size: 14px;">ğŸ‘¤ <span id="displayName">æ—…è¡Œè€…</span></span>
            </div>
            <div class="resource-pill glass-panel">
                <span style="color: #d946ef; font-weight:bold;">ğŸ’ 1250</span>
            </div>
        </div>

        <div id="view-hub" class="view-section active">
            <h2 class="section-header">æ¢ç´¢ä¸–ç•Œ</h2>
            <div class="grid-layout">
                <div class="card-instance glass-panel" onclick="showInstanceDetail()">
                    <div class="card-cover">
                        <img src="https://images.unsplash.com/photo-1599707367072-cd6ad6cb3d2e?w=600&q=80">
                        <div class="card-badge">å¤ä»£å®«å»·</div>
                    </div>
                    <div class="card-body">
                        <div class="card-title">ç´«ç¦åŸè¿·æ¢¦</div>
                        <div class="card-desc">æƒåŠ›ä¸çˆ±æ¬²äº¤ç»‡çš„æ·±å®«ï¼Œä½ èƒ½å¦ç‹¬å–„å…¶èº«ï¼Ÿ</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-detail" class="view-section">
            <button class="glass-panel" onclick="switchView('hub')" style="margin-bottom: 20px; padding: 10px 20px; border-radius: 12px; border:none; color:var(--text-main); cursor:pointer;">â† è¿”å›</button>
            <div class="detail-layout glass-panel">
                <div class="detail-cover">
                    <img src="https://images.unsplash.com/photo-1599707367072-cd6ad6cb3d2e?w=800">
                </div>
                <div class="detail-info">
                    <div>
                        <div class="detail-title">ç´«ç¦åŸè¿·æ¢¦</div>
                        <div class="tag-row"><span class="tag">æƒè°‹</span><span class="tag">æ‹çˆ±</span></div>
                        <div class="detail-desc">ç©¿è¶Šåˆ°æ˜æœæ°¸ä¹å¹´é—´...</div>
                    </div>
                    <div>
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <button class="btn-glow" style="flex:1" onclick="startGame('start')">ğŸ“– æ–°æ—…ç¨‹</button>
                            <button class="btn-glow" style="flex:1; background:rgba(16, 185, 129, 0.3);" onclick="startGame('continue')">ğŸ“‚ ç»§ç»­å‰§æƒ…</button>
                        </div>
                        <button class="btn-glow" onclick="startGame('endless')" style="width:100%; background:rgba(255,255,255,0.1);">â™¾ï¸ æ— å°½æ¨¡å¼</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-gallery" class="view-section">
            <div class="glass-panel" style="padding:20px; border-radius:20px;">
                <h2>è®°å¿†å›å»Š</h2>
                <div id="storyLog" class="log-container">æš‚æ— è®°å¿†</div>
                <button class="btn-glow" onclick="clearMemory()" style="margin-top:15px; background:rgba(239,68,68,0.5);">ğŸ—‘ï¸ æ¸…ç©ºè®°å¿†</button>
            </div>
        </div>

        <div id="view-shop" class="view-section">
            <h2>é“å…·å•†åº—</h2>
            <p>å¼€å‘ä¸­...</p>
        </div>

        <!-- ä¿®å¤åçš„ä¸ªäººè®¾å®šé¡µ -->
        <div id="view-persona" class="view-section">
            <div class="persona-container">
                <div class="glass-panel" style="border-radius: 20px; padding: 12px 16px; margin-bottom: 20px;">
                    <div class="persona-strip" id="persona-strip"></div>
                </div>
                <div class="glass-panel persona-form">
                    <input id="persona-name" class="input-modern" placeholder="è§’è‰²å">
                    <textarea id="persona-desc" class="input-modern" style="min-height:100px; resize:vertical;" placeholder="è®¾å®š..."></textarea>
                    <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px;">
                        <div class="persona-avatar-slot" onclick="triggerAvatarUpload()">
                            <img id="persona-avatar-preview" style="display:none; width:100%; height:100%; object-fit:cover;">
                            <span id="persona-placeholder" style="font-size:10px;">ä¸Šä¼ å¤´åƒ</span>
                        </div>
                        <input type="file" id="persona-avatar-input" accept="image/*" style="display:none;" onchange="onAvatarFileChange(event)">
                    </div>
                    <button class="btn-glow" onclick="savePersona()">ä¿å­˜è®¾å®š</button>
                </div>
            </div>
        </div>

        <div id="view-settings" class="view-section">
            <h2>ç³»ç»Ÿè®¾ç½®</h2>
            <div class="glass-panel" style="padding:20px; margin-top:20px; border-radius:16px;">
                <h3>API è¿æ¥</h3>
                <input id="apiUrl" class="input-modern" placeholder="API åœ°å€">
                <input id="apiKey" class="input-modern" type="password" placeholder="sk-...">
                <button class="btn-glow" onclick="saveApiConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
            </div>
            
            <!-- è‡ªå®šä¹‰ CSS -->
            <div class="glass-panel" style="padding:20px; margin-top:20px; border-radius:16px;">
                <h3>ğŸ¨ è‡ªå®šä¹‰æ ·å¼</h3>
                <textarea id="cssInput" class="input-modern" style="min-height: 100px; font-family: monospace; font-size: 12px;" placeholder="åœ¨æ­¤è¾“å…¥ CSS ä»£ç ..."></textarea>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="btn-glow" onclick="saveCss()">åº”ç”¨</button>
                    <button class="btn-glow" style="background:rgba(239,68,68,0.5); width:auto;" onclick="clearCss()">æ¸…é™¤</button>
                </div>
            </div>
        </div>

        <div class="dock-nav glass-panel">
            <div class="dock-item active" onclick="switchView('hub')"><span class="material-symbols-outlined">home</span></div>
            <div class="dock-item" onclick="switchView('gallery')"><span class="material-symbols-outlined">history_edu</span></div>
            <div class="dock-item" onclick="switchView('shop')"><span class="material-symbols-outlined">shopping_cart</span></div>
            <div class="dock-item" onclick="switchView('persona')"><span class="material-symbols-outlined">person</span></div>
            <div class="dock-item" onclick="switchView('settings')"><span class="material-symbols-outlined">settings</span></div>
        </div>
    </div>

    <div id="gameContainer" class="game-container">
        <div id="gameBg" class="game-bg"></div>
        <div class="game-top-bar">
            <button class="game-btn-small" onclick="saveProgress(true)" style="background:rgba(16, 185, 129, 0.6);">ğŸ’¾ å­˜æ¡£</button>
            <button class="game-btn-small" onclick="exitGame()">âŒ é€€å‡º</button>
        </div>
        <div class="game-content">
            <div id="gameTextBox" class="game-text-box"><span id="gameText"></span></div>
            <div id="gameOptions" class="game-options"></div>
        </div>
    </div>

    <!-- å¼¹çª—é€‰æ‹©äººè®¾ -->
    <div id="personaModal" class="modal-overlay">
        <div class="modal-card glass-panel">
            <div class="modal-header">
                <h3>é€‰æ‹©ä½ çš„èº«ä»½</h3>
                <button class="close-btn" onclick="closePersonaModal()">Ã—</button>
            </div>
            <div id="modalPersonaList" class="modal-list"></div>
            <div id="modalEmptyState" style="display:none; text-align:center; padding:20px;">
                <p>æš‚æ— å¯ç”¨äººè®¾</p>
                <button class="btn-glow" onclick="goToPersonaCreate()">å»åˆ›å»º</button>
            </div>
        </div>
    </div>

    <script>
        // === å…¨å±€å˜é‡ ===
        const STORAGE = { USER: 'infinite.user', PERSONA: 'infinite.personas', STORY: 'infinite.story', SAVE: 'infinite.save', API: 'apiConfig', CSS: 'infinite.css', FONT: 'infinite.font' };
        let currentPersonaId = null;
        let currentSceneId = null;
        let activeStoryData = {};
        let typingTimer = null;
        let isTyping = false;

        // é»˜è®¤å‰§æœ¬
        const storyData = {
            start: { type: 'fixed', bg: 'https://images.unsplash.com/photo-1599707367072-cd6ad6cb3d2e?w=800', text: "å¤œé£å¾®å‡‰ï¼Œä½ ç«™åœ¨ç´«ç¦åŸçš„é•¿è¡—ä¸Š...", options: [{ text: 'è¿›å…¥', nextScene: 'scene_enter' }] },
            scene_enter: { type: 'ai', bg: "https://images.unsplash.com/photo-1563298723-dcfebaa392e3?w=800", prompt: "åœºæ™¯ï¼šæ·±å¤œçš„å‚¨ç§€å®«ã€‚äººç‰©ï¼šæŒäº‹å§‘å§‘ã€‚äº‹ä»¶ï¼šä¸»è§’è¿Ÿåˆ°ã€‚ç”Ÿæˆå¯¹è¯ã€‚", options: [{ text: "è®¤é”™", nextScene: "ai_next" }] },
            ai_start: { type: "ai", prompt: "ç”Ÿæˆæ— é™æµèµ›åšæœ‹å…‹å¼€åœºã€‚", options: [{text:"é†’æ¥", nextScene:"ai_next"}] }
        };

        function init() {
            loadApiConfig();
            loadCustomStory();
            loadCss(); // åŠ è½½è‡ªå®šä¹‰CSS
            initPersonas();
            const u = localStorage.getItem(STORAGE.USER);
            if(u) { document.getElementById('username').value = u; enterHub(); }
        }

        // CSS è‡ªå®šä¹‰é€»è¾‘
        function loadCss() {
            const css = localStorage.getItem(STORAGE.CSS);
            if(css) {
                document.getElementById('user-custom-css').innerHTML = css;
                const input = document.getElementById('cssInput');
                if(input) input.value = css;
            }
        }
        function saveCss() {
            const css = document.getElementById('cssInput').value;
            localStorage.setItem(STORAGE.CSS, css);
            document.getElementById('user-custom-css').innerHTML = css;
            showToast('æ ·å¼å·²åº”ç”¨');
        }
        function clearCss() {
            localStorage.removeItem(STORAGE.CSS);
            document.getElementById('user-custom-css').innerHTML = '';
            document.getElementById('cssInput').value = '';
            showToast('å·²æ¸…é™¤');
        }

        function switchView(id) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + id).classList.add('active');
            document.querySelectorAll('.dock-item').forEach(el => el.classList.remove('active'));
            const map = ['hub','gallery','shop','persona','settings'];
            const idx = map.indexOf(id);
            if(idx!==-1) document.querySelectorAll('.dock-item')[idx].classList.add('active');
            if(id==='gallery') refreshStoryLog();
        }
        function showInstanceDetail() { switchView('detail'); }
        function enterHub() {
            const name = document.getElementById('username').value;
            localStorage.setItem(STORAGE.USER, name);
            document.getElementById('displayName').innerText = name;
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainHub').style.display = 'block';
        }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display='none', 2000);
        }

        // === æ¸¸æˆé€»è¾‘ ===
        let pendingGameMode = null;

        function startGame(mode) {
            if (mode === 'start' || mode === 'endless') {
                if (!currentPersonaId) { openPersonaModal(mode); return; }
            }
            
            document.getElementById('mainHub').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'block';

            if (mode === 'continue') {
                const save = JSON.parse(localStorage.getItem(STORAGE.SAVE));
                if (save) {
                    if(save.memory) activeStoryData.memory = save.memory;
                    loadScene(save.sceneId);
                    return;
                } else { showToast("æ— å­˜æ¡£"); }
            }
            
            if (mode !== 'continue') {
                if(activeStoryData) activeStoryData.memory = "";
                localStorage.removeItem(STORAGE.SAVE);
            }

            let startId = 'start';
            if(mode === 'endless') startId = 'ai_start';
            else if(!activeStoryData[startId]) startId = Object.keys(activeStoryData)[0];
            
            loadScene(startId);
        }

        function exitGame() {
            document.getElementById('gameContainer').style.display = 'none';
            document.getElementById('mainHub').style.display = 'block';
            switchView('detail');
        }

        function saveProgress(showMsg=false) {
            if(!currentSceneId) return;
            const save = { sceneId: currentSceneId, memory: activeStoryData.memory||"", time: Date.now() };
            localStorage.setItem(STORAGE.SAVE, JSON.stringify(save));
            if(showMsg) showToast("âœ… å­˜æ¡£æˆåŠŸ");
        }

        function updateMemory(text) {
            let mem = activeStoryData.memory || "";
            mem += "\n" + text;
            if(mem.length > 3000) mem = "..." + mem.slice(-3000);
            activeStoryData.memory = mem;
            saveProgress();
        }

        async function loadScene(sid) {
            currentSceneId = sid;
            saveProgress();

            let scene = activeStoryData[sid];
            if(!scene && sid.startsWith('ai_')) {
                scene = { type: 'ai', prompt: "æ¥ç»­å‰§æƒ…...", bg: "" };
            }
            if(!scene) { alert('å‰§æœ¬ç»“æŸ'); exitGame(); return; }

            const bg = document.getElementById('gameBg');
            const opts = document.getElementById('gameOptions');
            const txt = document.getElementById('gameText');

            if(bg && scene.bg) bg.style.backgroundImage = `url('${scene.bg}')`;
            opts.innerHTML = '';

            if (scene.type === 'fixed') {
                typeWriter(scene.text);
                updateMemory(scene.text);
                renderOpts(scene.options);
            } else {
                txt.innerHTML = '<span style="opacity:0.7">âš¡ ç”Ÿæˆä¸­...</span>';
                const res = await generateAiSceneText(sid, scene);
                
                if(typeof res === 'string' && res.startsWith('âŒ')) {
                    txt.innerText = res;
                    renderOpts([{text:"é‡è¯•", nextScene: sid}]);
                } else {
                    typeWriter(res.text);
                    updateMemory(res.text);
                    renderOpts(res.options);
                }
            }
        }

        function typeWriter(text) {
            const el = document.getElementById('gameText');
            el.innerText = "";
            let i = 0;
            if(typingTimer) clearInterval(typingTimer);
            isTyping = true;
            typingTimer = setInterval(() => {
                el.innerText += text.charAt(i);
                i++;
                if(i>=text.length) { clearInterval(typingTimer); isTyping = false; }
            }, 20);
            document.getElementById('gameTextBox').onclick = () => {
                if(isTyping) { clearInterval(typingTimer); el.innerText = text; isTyping = false; }
            };
        }

        function renderOpts(list) {
            const div = document.getElementById('gameOptions');
            div.innerHTML = '';
            if(!list) return;
            list.forEach(o => {
                const b = document.createElement('div');
                b.className = 'game-option-btn';
                b.innerText = o.text || o.label;
                b.onclick = () => {
                    let next = o.nextScene;
                    if(!next || next==='null') {
                        next = 'ai_next_' + Date.now();
                        activeStoryData[next] = { type:'ai', prompt: `ç©å®¶é€‰äº†ï¼š${b.innerText}ã€‚è¯·ç»§ç»­ã€‚` };
                    }
                    loadScene(next);
                };
                div.appendChild(b);
            });
        }

        async function generateAiSceneText(sid, scene) {
            const cfg = JSON.parse(localStorage.getItem(STORAGE.API)||'{}');
            if(!cfg.key) return 'âŒ æœªé…ç½® API Key';
            
            let url = cfg.url || "https://api.openai.com/v1";
            url = url.replace(/\/$/, "");
            if(!url.includes("chat/completions")) url = url.endsWith("/v1") ? url+"/chat/completions" : url+"/v1/chat/completions";

            // è·å–äººè®¾
            const allPersonas = loadPersonas();
            const myPersona = allPersonas.find(p => p.id === currentPersonaId) || { name: "ç©å®¶", desc: "æ™®é€šäºº" };

            const mem = activeStoryData.memory || "";
            const sys = `ä½ æ˜¯ä¸€ä¸ªæ— é™æµæ–‡å­—æ¸¸æˆAIã€‚
ã€ç©å®¶äººè®¾ã€‘ï¼š${myPersona.name} (${myPersona.desc})ã€‚
ã€å‰æƒ…æè¦ã€‘ï¼š${mem}
ã€æŒ‡ä»¤ã€‘ï¼šæ¥ç»­å‰§æƒ…ï¼Œ200å­—ä»¥å†…ï¼Œç¬¦åˆäººè®¾ã€‚
è¿”å›æ ¼å¼ï¼šçº¯JSON {"text":"...", "options":[{"text":"...", "nextScene":"null"}]}`;

            try {
                const res = await fetch(url, {
                    method:'POST',
                    headers: {'Content-Type':'application/json', 'Authorization': 'Bearer '+cfg.key},
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        stream: false,
                        messages: [{role:'system', content:sys}, {role:'user', content: scene.prompt || "ç»§ç»­"}]
                    })
                });
                const d = await res.json();
                if(d.error) return `âŒ APIé”™è¯¯: ${d.error.message}`;
                const c = d.choices?.[0]?.message?.content;
                if(!c) return `âŒ ç©ºå†…å®¹`;
                
                try { return JSON.parse(c.replace(/```json/g,'').replace(/```/g,'').trim()); }
                catch { return { text: c, options: [{text:"ç»§ç»­", nextScene:"ai_next"}] }; }
            } catch(e) { return `âŒ ç½‘ç»œé”™: ${e.message}`; }
        }

        // === è¾…åŠ©åŠŸèƒ½ ===
        function saveApiConfig() {
            const url = document.getElementById('apiUrl').value;
            const key = document.getElementById('apiKey').value;
            localStorage.setItem(STORAGE.API, JSON.stringify({url, key}));
            showToast('API å·²ä¿å­˜');
        }
        function loadApiConfig() {
            const c = JSON.parse(localStorage.getItem(STORAGE.API)||'{}');
            if(c.url) document.getElementById('apiUrl').value = c.url;
            if(c.key) document.getElementById('apiKey').value = c.key;
        }

        // ä¸ªäººè®¾å®š
        function initPersonas() { renderPersonaStrip(); }
        function loadPersonas() { return JSON.parse(localStorage.getItem(STORAGE.PERSONA)||'[]'); }
        function renderPersonaStrip() {
            const list = loadPersonas();
            const el = document.getElementById('persona-strip');
            el.innerHTML = '<div class="persona-avatar-slot" style="width:50px;height:50px;font-size:24px;color:#888;" onclick="resetPersonaForm()">+</div>';
            list.forEach(p => {
                const div = document.createElement('div');
                div.className = 'persona-chip' + (p.id === currentPersonaId ? ' active' : '');
                div.innerHTML = `<div class="persona-avatar">${p.avatar ? `<img src="${p.avatar}">` : (p.name[0]||'?')}</div><div class="persona-name">${p.name}</div>`;
                div.onclick = () => selectPersona(p.id);
                el.appendChild(div);
            });
        }
        function selectPersona(id) {
            currentPersonaId = id;
            const p = loadPersonas().find(x=>x.id===id) || {name:'', desc:'', avatar:''};
            document.getElementById('persona-name').value = p.name;
            document.getElementById('persona-desc').value = p.desc;
            const pv = document.getElementById('persona-avatar-preview');
            const ph = document.getElementById('persona-placeholder');
            if(p.avatar) { pv.src = p.avatar; pv.style.display='block'; ph.style.display='none'; }
            else { pv.style.display='none'; ph.style.display='block'; }
            renderPersonaStrip();
        }
        function savePersona() {
            const name = document.getElementById('persona-name').value;
            const desc = document.getElementById('persona-desc').value;
            const pv = document.getElementById('persona-avatar-preview');
            const av = pv.style.display==='block' ? pv.src : '';
            if(!name) return showToast('è¯·è¾“å…¥åå­—');
            let list = loadPersonas();
            if(currentPersonaId) {
                const i = list.findIndex(x=>x.id===currentPersonaId);
                if(i>=0) list[i] = {...list[i], name, desc, avatar:av};
            } else {
                const nid = Date.now();
                list.push({id:nid, name, desc, avatar:av});
                currentPersonaId = nid;
            }
            localStorage.setItem(STORAGE.PERSONA, JSON.stringify(list));
            renderPersonaStrip();
            showToast('è®¾å®šå·²ä¿å­˜');
        }
        function triggerAvatarUpload() { document.getElementById('persona-avatar-input').click(); }
        function onAvatarFileChange(e) {
            const f = e.target.files[0];
            const r = new FileReader();
            r.onload = (ev) => {
                const img = document.getElementById('persona-avatar-preview');
                img.src = ev.target.result;
                img.style.display = 'block';
                document.getElementById('persona-placeholder').style.display = 'none';
            };
            r.readAsDataURL(f);
        }
        
        function openPersonaModal(mode) {
            pendingGameMode = mode;
            document.getElementById('personaModal').style.display = 'flex';
            const list = loadPersonas();
            const container = document.getElementById('modalPersonaList');
            const empty = document.getElementById('modalEmptyState');
            container.innerHTML = '';
            if(list.length === 0) { container.style.display='none'; empty.style.display='block'; }
            else {
                container.style.display='grid'; empty.style.display='none';
                list.forEach(p => {
                    const d = document.createElement('div');
                    d.className = 'persona-select-item';
                    d.innerHTML = `<div>${p.name}</div>`;
                    d.onclick = () => {
                        currentPersonaId = p.id;
                        closePersonaModal();
                        showToast("èº«ä»½å·²åˆ‡æ¢: "+p.name);
                        startGame(pendingGameMode);
                    };
                    container.appendChild(d);
                });
            }
        }
        function closePersonaModal() { document.getElementById('personaModal').style.display = 'none'; }
        function goToPersonaCreate() { closePersonaModal(); switchView('persona'); resetPersonaForm(); }
        function resetPersonaForm() {
            currentPersonaId = null;
            document.getElementById('persona-name').value = '';
            document.getElementById('persona-desc').value = '';
            document.getElementById('persona-avatar-preview').style.display = 'none';
            document.getElementById('persona-placeholder').style.display = 'block';
        }

        // å‰§æœ¬åŠ è½½
        function loadCustomStory() {
            const raw = localStorage.getItem(STORAGE.STORY);
            if(raw) {
                try {
                    const d = JSON.parse(raw);
                    activeStoryData = d.main_story || d;
                } catch {}
            }
        }
        function handleStoryUpload(e) {
            const f = e.target.files[0];
            const r = new FileReader();
            r.onload = (ev) => {
                localStorage.setItem(STORAGE.STORY, ev.target.result);
                loadCustomStory();
                showToast('å‰§æœ¬åŠ è½½æˆåŠŸ');
            };
            r.readAsText(f);
        }
        function resetStory() { localStorage.removeItem(STORAGE.STORY); activeStoryData = storyData; showToast('å·²é‡ç½®é»˜è®¤'); }
        function refreshStoryLog() {
            const el = document.getElementById('storyLog');
            const save = JSON.parse(localStorage.getItem(STORAGE.SAVE));
            el.innerText = save ? (save.memory || "æš‚æ— å‰§æƒ…") : "æš‚æ— å­˜æ¡£";
        }
        function clearMemory() { localStorage.removeItem(STORAGE.SAVE); if(activeStoryData) activeStoryData.memory=""; refreshStoryLog(); showToast("è®°å¿†å·²æ¸…ç©º"); }

        window.onload = init;
    </script>
</body>
</html>
